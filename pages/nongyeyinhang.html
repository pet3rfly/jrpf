<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†œè¡Œæ‰¹å¤é€šçŸ¥</title>
    <style>
        :root {
            --theme-color: #008d7c;
            --bg-gray: #f2f2f2;
            --border-color: #999;
            --main-font: "SimSun", "Songti SC", serif;
            --accent-font: "Microsoft YaHei", "Heiti SC", sans-serif;
        }

        body {
            font-family: var(--main-font);
            margin: 0;
            padding: 20px;
            background-color: #fff;
            color: #333;
            min-height: 100vh;
            overflow-x: auto; 
        }

        .main-container {
            width: 1200px;
            margin: 0 auto;
            position: relative;
            padding-bottom: 80px; 
        }

        /* ---------------- å¤´éƒ¨åŒºåŸŸ ---------------- */
        .header {
            text-align: center;
            margin-bottom: 0;
            margin-top: 60px; 
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: #000;
            letter-spacing: 2px;
        }

        .print-date-wrapper {
            font-size: 16px;
            color: #333;
            cursor: pointer;
            position: relative;
            padding: 5px 10px;
            display: inline-block;
        }
        .print-date-wrapper:hover {
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        
        #printDateInput {
            position: absolute;
            top: -10%; left: -10%; 
            width: 120%; height: 120%; 
            opacity: 0; 
            z-index: 999; 
            cursor: pointer;
        }

        .export-btn {
            background-color: var(--theme-color);
            color: #fff;
            border: none;
            padding: 8px 30px;
            font-size: 16px;
            border-radius: 8px; 
            cursor: pointer;
            font-family: var(--accent-font);
            margin-bottom: -1px;
            position: relative;
            z-index: 5;
        }
        .export-btn:hover { opacity: 0.9; }

        /* ---------------- è¡¨æ ¼åŒºåŸŸ ---------------- */
        .loan-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
            font-size: 16px;
            white-space: nowrap; 
        }

        .loan-table td {
            border: 1px solid var(--border-color);
            padding: 0; 
            height: 28px;
            vertical-align: middle;
        }

        .cell-content {
            padding: 0 10px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            box-sizing: border-box; 
        }

        .loan-table tr:nth-child(odd) { background-color: var(--bg-gray); }
        .loan-table tr:nth-child(even) { background-color: #fff; }

        .label-text {
            color: var(--theme-color);
            font-weight: bold;
            text-align: center;
            display: block;
            width: 100%;
        }

        .loan-table td:nth-child(1),
        .loan-table td:nth-child(3) {
            width: 200px; 
            text-align: center;
        }

        .table-input {
            width: 100%; height: 100%; border: none; outline: none;
            background: transparent; font-family: var(--main-font);
            font-size: 16px; color: #000; padding: 0; margin: 0;
            text-align: left; 
        }

        .clean-select {
            width: 100%; height: 100%; border: none; outline: none;
            background: transparent; font-family: var(--main-font);
            font-size: 16px; color: #000; padding: 0; margin: 0;
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            cursor: pointer;
        }
        .clean-select::-ms-expand { display: none; }

        .split-cell-container { display: flex; width: 100%; height: 100%; align-items: stretch; }
        .split-value { flex: 3; border-right: none; padding: 0 10px; display: flex; align-items: center; }
        .split-unit { flex: 1; display: flex; align-items: center; justify-content: flex-start; padding-left: 0px; color: #000; }

        .footer-note {
            margin-top: 5px; font-size: 14px; color: red; font-family: var(--accent-font);
        }

        /* ---------------- æ§åˆ¶é¢æ¿ ---------------- */
        .control-panel {
            position: fixed; bottom: 20px; right: 20px; background: #fff;
            border: 1px solid #ccc; padding: 0; z-index: 9999;
            width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.15);
            border-radius: 8px; font-size: 13px; font-family: "Microsoft YaHei";
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }
        
        .control-panel.collapsed {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--theme-color); cursor: pointer;
            border: none;
            display: flex; align-items: center; justify-content: center;
        }
        .control-panel.collapsed .panel-content { opacity: 0; pointer-events: none; }
        .toggle-icon { display: none; color: white; font-size: 24px; }
        .control-panel.collapsed .toggle-icon { display: block; }

        .panel-content { padding: 15px; opacity: 1; transition: opacity 0.3s; }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--theme-color); 
            margin-bottom: 15px; padding-bottom: 8px;
        }
        .panel-header h4 { margin: 0; color: var(--theme-color); font-size: 16px; }
        
        .minimize-btn { 
            cursor: pointer; font-size: 20px; color: #999; 
            width: 24px; height: 24px; line-height: 20px; text-align: center;
        }
        .minimize-btn:hover { color: #333; background: #eee; border-radius: 4px; }

        .section-title {
            font-weight: bold; color: #666; margin: 15px 0 5px 0; font-size: 12px;
            border-left: 3px solid var(--theme-color); padding-left: 6px;
        }
        .section-title:first-child { margin-top: 0; }

        .control-row { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .control-row label { color: #555; }
        .control-row select, .control-row input { flex: 1; margin-left: 8px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn-full { width: 100%; padding: 6px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-top: 5px; color: #333; }
        .btn-full:hover { background: #e0e0e0; }

        .btn-primary { background: var(--theme-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: #ff5252; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        
        /* äº‘åŒæ­¥ç›¸å…³æ ·å¼ */
        .cloud-status { font-size: 10px; color: #999; text-align: right; margin-top: 2px; }
        .cloud-status.success { color: green; }
        .cloud-status.error { color: red; }
        .cloud-row { display: flex; gap: 5px; margin-top: 5px; }
        .btn-cloud { flex: 1; font-size: 12px; padding: 5px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-upload { background: #2196F3; } .btn-upload:hover { background: #1976D2; }
        .btn-download { background: #FF9800; } .btn-download:hover { background: #F57C00; }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <h1>è´·æ¬¾å®¡æ‰¹é€šçŸ¥ä¹¦</h1>
            <div class="print-date-wrapper">
                æ‰“å°æ—¥æœŸï¼š<span id="printDateText">2025å¹´12æœˆ18æ—¥</span>
                <input type="date" id="printDateInput" onchange="updatePrintDate(this.value)" onclick="this.showPicker()">
            </div>
            <button class="export-btn" onclick="window.print()">æ‰“å°/å¯¼å‡ºPDF</button>
        </div>

        <table class="loan-table">
            <tr>
                <td><div class="cell-content"><span class="label-text">ç”³è¯·ä¹¦ç¼–å·</span></div></td>
                <td colspan="3"><div class="cell-content"><input type="text" class="table-input" id="appNumber" value="34300202572722741"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">å®¢æˆ·åç§°</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="custName" value="å‘¨è£"></div></td>
                <td><div class="cell-content"><span class="label-text">å®¢æˆ·ä»£ç </span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="custCode" value="1639504313407339"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">ä¸šåŠ¡å“ç§</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="bizType" value="æˆ¿æŠµè´·â€”â€”ç»è¥"></div></td>
                <td><div class="cell-content"><span class="label-text">æ˜¯å¦ä½é£é™©</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="riskLevel" value="æ˜¯"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">æ˜¯å¦å¾ªç¯è´·æ¬¾å•ç¬”ç”¨ä¿¡å®¡æ‰¹</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="isLoopSingle" value="å¦"></div></td>
                <td><div class="cell-content"><span class="label-text">å…³è”å¾ªç¯åˆåŒç¼–å·</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="loopContractNo"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">åˆä½œå“ç§ç¼–å·</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="coopVarietyNo"></div></td>
                <td><div class="cell-content"><span class="label-text">åˆä½œé¡¹ç›®ç¼–å·</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="coopProjectNo"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">åˆä½œé¡¹ç›®åç§°</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="coopProjectName"></div></td>
                <td><div class="cell-content"><span class="label-text">ç‰¹è‰²äº§å“</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="featureProduct"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">è´·æ¬¾æ€§è´¨</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="loanNature" value="è‡ªè¥å¸¸è§„è´·æ¬¾"></div></td>
                <td><div class="cell-content"><span class="label-text">å§”æ‰˜äººåˆ†ç±»</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="trusteeClass"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">è´·æ¬¾é‡‘é¢</span></div></td>
                <td>
                    <div class="split-cell-container">
                        <div class="split-value"><input type="text" class="table-input" id="loanAmt" value="4,500,000.00"></div>
                        <div class="split-unit">å…ƒ</div>
                    </div>
                </td>
                <td><div class="cell-content"><span class="label-text">æœŸé™</span></div></td>
                <td>
                    <div class="split-cell-container">
                        <div class="split-value"><input type="text" class="table-input" id="termMonth" value="36"></div>
                        <div class="split-unit">æœˆ</div>
                    </div>
                </td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">æ˜¯å¦å¾ªç¯</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="isLoop" value="å¦"></div></td>
                <td><div class="cell-content"><span class="label-text">å¾ªç¯å®¡æ‰¹æ–¹å¼</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="loopMethod"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">å¾ªç¯é¢åº¦é‡‘é¢</span></div></td>
                <td>
                    <div class="split-cell-container">
                        <div class="split-value"><input type="text" class="table-input" id="loopAmt" value="0.00"></div>
                        <div class="split-unit">å…ƒ</div>
                    </div>
                </td>
                <td><div class="cell-content"><span class="label-text">å¾ªç¯é¢åº¦æœŸé™</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="loopTerm"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">é¦–ç¬”è´·æ¬¾ä¸šåŠ¡å“ç§</span></div></td>
                <td>
                    <div class="cell-content">
                        <select class="clean-select" id="firstBizType">
                            <option selected>æˆ¿æŠµè´·â€”â€”ç»è¥</option>
                            <option>æˆ¿æŠµè´·â€”â€”æ¶ˆè´¹</option>
                        </select>
                    </div>
                </td>
                <td></td><td></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">è´·æ¬¾ç”¨é€”</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="loanUse" value="ç»è¥"></div></td>
                <td><div class="cell-content"><span class="label-text">è´·æ¬¾ç”¨é€”è¯´æ˜</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="loanUseDesc"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">é¦–ä»˜é‡‘é¢</span></div></td>
                <td>
                    <div class="split-cell-container">
                        <div class="split-value"><input type="text" class="table-input" id="downPayAmt" value="0.00"></div>
                        <div class="split-unit">å…ƒ</div>
                    </div>
                </td>
                <td><div class="cell-content"><span class="label-text">é¦–ä»˜æ¯”ä¾‹</span></div></td>
                <td>
                    <div class="cell-content">
                        <input type="text" class="table-input" id="downPayRatio" value="0.00 %" onfocus="removeSuffix(this, ' %')" onblur="addSuffixRatio(this)">
                    </div>
                </td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">è¿˜æ¬¾æ¥æº</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="repaySource" value="ç»è¥æ”¶å…¥"></div></td>
                <td><div class="cell-content"><span class="label-text">æ‹…ä¿æ–¹å¼</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="guaranteeMode" value="æŠµæŠ¼"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">æ˜¯å¦æœ‰å…±åŒå€Ÿæ¬¾äºº</span></div></td>
                <td>
                    <div class="cell-content">
                        <select class="clean-select" id="hasCoBorrower">
                            <option selected>å¦</option>
                            <option>æ˜¯</option>
                        </select>
                    </div>
                </td>
                <td><div class="cell-content"><span class="label-text">æ˜¯å¦å…¬ç§¯é‡‘ç»„åˆè´·æ¬¾</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="isFundCombo" value="å¦"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">è¿˜æ¬¾æ–¹å¼</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="repayMethod" value="ä¸€æ¬¡æ€§è¿˜æœ¬æŒ‰çº¦è¿˜æ¯"></div></td>
                <td><div class="cell-content"><span class="label-text">åŸºå‡†åˆ©ç‡ç±»åˆ«</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="baseRateType" value="è´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">æ‰§è¡Œåˆ©ç‡ç±»åˆ«</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="execRateType" value="æµ®åŠ¨åˆ©ç‡"></div></td>
                <td><div class="cell-content"><span class="label-text">åˆ©ç‡æµ®åŠ¨å‘¨æœŸ</span></div></td>
                <td>
                    <div class="cell-content">
                        <select class="clean-select" id="rateLoopCycle">
                            <option selected>æŒ‰12ä¸ªæœˆ</option>
                            <option>æŒ‰36ä¸ªæœˆ</option>
                            <option>æŒ‰60ä¸ªæœˆ</option>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">åˆ©ç‡æµ®åŠ¨æ–¹å¼</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="rateFloatType" value="æµ®ç‚¹"></div></td>
                <td><div class="cell-content"><span class="label-text">åˆ©ç‡æµ®åŠ¨å¹…åº¦</span></div></td>
                <td>
                    <div class="cell-content">
                        <input type="text" class="table-input" id="rateFloatValue" value="31.00000 ä¸‡åˆ†ä¹‹" onfocus="removeSuffix(this, ' ä¸‡åˆ†ä¹‹')" onblur="addSuffixFloat(this)">
                    </div>
                </td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">å®¡æ‰¹æ„è§</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="approveOpinion" value="åŒæ„"></div></td>
                <td><div class="cell-content"><span class="label-text">å®¡æ‰¹æœºæ„</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="approvalOrg" value="åˆè‚¥æœ›æ±Ÿä¸œè·¯æ”¯è¡Œè¡Œé•¿å®¤"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">ç»è¥æœºæ„</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="operatingOrg" value="åˆè‚¥æœ›æ±Ÿä¸œè·¯æ”¯è¡Œ"></div></td>
                <td><div class="cell-content"><span class="label-text">æ‰¹å¤æœ‰æ•ˆæˆªæ­¢æ—¥æœŸ</span></div></td>
                <td><div class="cell-content"><input type="text" class="table-input" id="tableEndDate" value="2026-02-16"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">ä¿¡ç”¨å‘æ”¾æ¡ä»¶</span></div></td>
                <td colspan="3"><div class="cell-content"><input type="text" class="table-input" id="creditCondition"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">å…¶ä»–è¦æ±‚</span></div></td>
                <td colspan="3"><div class="cell-content"><input type="text" class="table-input" id="otherReq"></div></td>
            </tr>
            <tr>
                <td><div class="cell-content"><span class="label-text">å®¡æ‰¹æ„è§è¯´æ˜</span></div></td>
                <td colspan="3"><div class="cell-content"><input type="text" class="table-input" id="approveOpinionDesc" value="åŒæ„"></div></td>
            </tr>
        </table>
        
        <div class="footer-note">
            å¾ªç¯é¢åº¦ä¸é¦–ç¬”ç”¨ä¿¡åŒæ—¶å®¡æ‰¹æ—¶ï¼Œè´·æ¬¾é‡‘é¢å³é¦–ç¬”ç”¨ä¿¡é‡‘é¢ï¼ŒæœŸé™å³é¦–ç¬”ç”¨ä¿¡æœŸé™ã€‚
        </div>
    </div>

    <div class="control-panel" id="controlPanel" onclick="handlePanelClick(event)">
        <div class="toggle-icon">âš™</div>
        
        <div class="panel-content">
            <div class="panel-header">
                <h4>è®¾ç½®ä¸æ¡£æ¡ˆ</h4>
                <span class="minimize-btn" onclick="minimizePanel(event)">_</span>
            </div>

            <div class="section-title">å¸¸ç”¨æ“ä½œ</div>
            <button class="btn-full" onclick="refreshNumbers()">ğŸ² åˆ·æ–°éšæœºç¼–å·</button>

            <div class="control-row">
                <label>é€‰æ‹©æ”¯è¡Œ:</label>
                <select id="branchSelect" onchange="updateBranchInfo()"></select>
            </div>
            <div class="control-row">
                <label>æ‰¹å¤æ—¥æœŸ:</label>
                <input type="date" id="panelApproveDate" onchange="updateDateLogic()">
            </div>

            <div class="section-title">æœ¬åœ°æ¡£æ¡ˆåº“</div>
            <div class="control-row">
                <input type="text" id="dbSaveName" placeholder="æ¡£æ¡ˆå (è‡ªåŠ¨ç”Ÿæˆ)">
                <button class="btn-primary" onclick="saveToDB()">ä¿å­˜</button>
            </div>
            <div class="control-row">
                <select id="dbList" onchange="loadFromDB()">
                    <option value="">-- å†å²è®°å½• --</option>
                </select>
                <button class="btn-danger" onclick="deleteFromDB()">åˆ </button>
            </div>

            <div class="section-title">GitHub äº‘åŒæ­¥ (Gist)</div>
            <div class="control-row">
                <input type="password" id="ghToken" placeholder="ç²˜è´´ GitHub Token" onchange="saveToken()">
            </div>
            <div class="cloud-status" id="cloudStatus">æœªé…ç½®</div>
            <div class="cloud-row">
                <button class="btn-cloud btn-upload" onclick="syncToCloud('upload')">â¬† ä¸Šä¼ åˆ°äº‘</button>
                <button class="btn-cloud btn-download" onclick="syncToCloud('download')">â¬‡ ä»äº‘ä¸‹è½½</button>
            </div>
        </div>
    </div>

    <script>
        const branches = ["ä¸ƒé‡Œå¡˜", "ä¸‡è¾¾å¹¿åœº", "ä¸´æ³‰è·¯", "ä¸´æ¹–", "åŒ—åŸ", "å—å²—", "å²æ²³è·¯", "åŸä¸œ", "å¤©æŸ±è·¯", "å¤©é¹…æ¹–", "å°åº™", "æ–°æ”¿åŠ¡åŒº", "æœ›æ±Ÿä¸œè·¯", "æ¡ƒèŠ±å·¥ä¸šå›­åŒº", "ç£¨åº—"];

        window.onload = function() {
            // åˆå§‹åŒ–æ”¯è¡Œ
            const select = document.getElementById('branchSelect');
            branches.forEach(br => {
                const option = document.createElement('option');
                option.value = br;
                option.text = br;
                if(br === 'æœ›æ±Ÿä¸œè·¯') option.selected = true; 
                select.appendChild(option);
            });

            // åˆå§‹åŒ–æ—¥æœŸ
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('panelApproveDate').value = todayStr;
            document.getElementById('printDateInput').value = todayStr;
            updatePrintDate(todayStr);
            updateDateLogic();
            
            // æ•°æ®åº“åˆå§‹åŒ–
            refreshList();
            
            // äº‘åŒæ­¥åˆå§‹åŒ–
            const savedToken = localStorage.getItem('GH_TOKEN');
            if(savedToken) {
                document.getElementById('ghToken').value = savedToken;
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        };

        // UIäº¤äº’
        function handlePanelClick(e) {
            const panel = document.getElementById('controlPanel');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
            }
        }
        function minimizePanel(e) {
            e.stopPropagation(); 
            document.getElementById('controlPanel').classList.add('collapsed');
        }
        function removeSuffix(el, suffix) {
            if (el.value.endsWith(suffix)) el.value = el.value.replace(suffix, '');
        }
        function addSuffixRatio(el) {
            let val = el.value.trim().replace(/[% ]/g, '');
            let num = parseFloat(val);
            el.value = isNaN(num) ? val : num.toFixed(2) + ' %';
        }
        function addSuffixFloat(el) {
            let val = el.value.trim().replace(' ä¸‡åˆ†ä¹‹', '');
            let num = parseFloat(val);
            el.value = isNaN(num) ? val : num.toFixed(5) + ' ä¸‡åˆ†ä¹‹';
        }

        // ä¸šåŠ¡é€»è¾‘
        function refreshNumbers() {
            document.getElementById('appNumber').value = "343002025" + Math.floor(Math.random()*100000000);
            document.getElementById('custCode').value = "1639500" + Math.floor(Math.random()*10000000000);
        }
        function updateBranchInfo() {
            const br = document.getElementById('branchSelect').value;
            document.getElementById('operatingOrg').value = `åˆè‚¥${br}æ”¯è¡Œ`;
            document.getElementById('approvalOrg').value = `åˆè‚¥${br}æ”¯è¡Œè¡Œé•¿å®¤`;
        }
        function updateDateLogic() {
            const dStr = document.getElementById('panelApproveDate').value;
            if(!dStr) return;
            const date = new Date(dStr);
            date.setDate(date.getDate() + 60);
            document.getElementById('tableEndDate').value = date.toISOString().split('T')[0];
        }
        function updatePrintDate(val) {
            if(!val) return;
            const d = new Date(val);
            document.getElementById('printDateText').innerText = `${d.getFullYear()}å¹´${String(d.getMonth()+1).padStart(2,'0')}æœˆ${String(d.getDate()).padStart(2,'0')}æ—¥`;
        }

        /* ================= æœ¬åœ°æ•°æ®åº“é€»è¾‘ ================= */
        const fieldIds = [
            "printDateInput", "appNumber", "custName", "custCode", "bizType", "riskLevel",
            "isLoopSingle", "loopContractNo", "coopVarietyNo", "coopProjectNo", "coopProjectName",
            "featureProduct", "loanNature", "trusteeClass", "loanAmt", "termMonth", "isLoop",
            "loopMethod", "loopAmt", "loopTerm", "firstBizType", "loanUse", "loanUseDesc",
            "downPayAmt", "downPayRatio", "repaySource", "guaranteeMode", "hasCoBorrower",
            "isFundCombo", "repayMethod", "baseRateType", "execRateType", "rateLoopCycle",
            "rateFloatType", "rateFloatValue", "approveOpinion", "approvalOrg", "operatingOrg",
            "tableEndDate", "creditCondition", "otherReq", "approveOpinionDesc"
        ];
        const DB_KEY = "AGRI_BANK_DB";
        const GIST_FILENAME = "agri_bank_db.json";
        const GIST_DESC = "Bank System Database Backup";

        function saveToDB() {
            const custName = document.getElementById('custName').value.trim() || "æœªå‘½å";
            const now = new Date();
            const timeStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            
            let saveName = document.getElementById('dbSaveName').value.trim();
            if(!saveName) saveName = `${custName}_${timeStr}`;

            const data = {};
            fieldIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) data[id] = el.value;
            });

            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            allData[saveName] = data;
            localStorage.setItem(DB_KEY, JSON.stringify(allData));

            alert(`âœ… å·²ä¿å­˜åˆ°æœ¬åœ°: ${saveName}`);
            refreshList();
            document.getElementById('dbSaveName').value = "";
        }

        function loadFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            const data = allData[name];
            if(data) {
                fieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el && data[id] !== undefined) el.value = data[id];
                });
                updatePrintDate(data['printDateInput']);
            }
        }

        function deleteFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            if(!confirm(`åˆ é™¤ [${name}] ?`)) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            delete allData[name];
            localStorage.setItem(DB_KEY, JSON.stringify(allData));
            refreshList();
        }

        function refreshList() {
            const select = document.getElementById('dbList');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- å†å²è®°å½• --</option>';
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            Object.keys(allData).reverse().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                select.appendChild(opt);
            });
            if(allData[currentVal]) select.value = currentVal;
        }

        /* ================= äº‘åŒæ­¥é€»è¾‘ (GitHub Gist) ================= */
        function saveToken() {
            const token = document.getElementById('ghToken').value.trim();
            if(token) {
                localStorage.setItem('GH_TOKEN', token);
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        }

        async function syncToCloud(action) {
            const token = localStorage.getItem('GH_TOKEN');
            if(!token) {
                alert("è¯·å…ˆè¾“å…¥ GitHub Tokenï¼");
                return;
            }
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerText = "æ­£åœ¨è¿æ¥ GitHub...";
            statusDiv.className = "cloud-status";

            try {
                // 1. æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„ Gist
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `token ${token}` }
                });
                if(!userRes.ok) throw new Error("Token æ— æ•ˆ");
                
                // æœç´¢ç”¨æˆ·çš„ gists
                const gistsRes = await fetch('https://api.github.com/gists', {
                    headers: { Authorization: `token ${token}` }
                });
                const gists = await gistsRes.json();
                
                let targetGist = gists.find(g => g.description === GIST_DESC && g.files[GIST_FILENAME]);
                let gistId = targetGist ? targetGist.id : null;

                if (action === 'upload') {
                    // ä¸Šä¼ ï¼šæœ¬åœ° -> äº‘ç«¯
                    const content = localStorage.getItem(DB_KEY) || "{}";
                    const payload = {
                        description: GIST_DESC,
                        public: false,
                        files: { [GIST_FILENAME]: { content: content } }
                    };

                    let url = 'https://api.github.com/gists';
                    let method = 'POST';
                    if (gistId) {
                        url += `/${gistId}`;
                        method = 'PATCH';
                    }

                    await fetch(url, {
                        method: method,
                        headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    statusDiv.innerText = "âœ… ä¸Šä¼ æˆåŠŸï¼";
                    statusDiv.classList.add("success");
                    alert("äº‘ç«¯åŒæ­¥å®Œæˆï¼");

                } else if (action === 'download') {
                    // ä¸‹è½½ï¼šäº‘ç«¯ -> æœ¬åœ°
                    if (!gistId) {
                        alert("äº‘ç«¯è¿˜æ²¡æœ‰å¤‡ä»½æ–‡ä»¶ï¼è¯·å…ˆä¸Šä¼ ã€‚");
                        statusDiv.innerText = "äº‘ç«¯æ— æ–‡ä»¶";
                        return;
                    }
                    // è·å– gist è¯¦æƒ…ï¼ˆåŒ…å«åŸå§‹å†…å®¹ï¼‰
                    const detailRes = await fetch(`https://api.github.com/gists/${gistId}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    const detail = await detailRes.json();
                    const content = detail.files[GIST_FILENAME].content;
                    
                    localStorage.setItem(DB_KEY, content);
                    refreshList();
                    
                    statusDiv.innerText = "âœ… ä¸‹è½½æˆåŠŸï¼";
                    statusDiv.classList.add("success");
                    alert("å·²ä»äº‘ç«¯æ¢å¤æ•°æ®ï¼");
                }

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "âŒ å¤±è´¥: " + error.message;
                statusDiv.classList.add("error");
                alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æˆ–ç½‘ç»œã€‚");
            }
        }
    </script>
</body>
</html>