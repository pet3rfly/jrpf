<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ¦å‘å®¡æ‰¹é€šçŸ¥</title>
    <style>
        :root {
            --bg-gray: #eaeaea;      
            --border-gray: #b8b8b8;  
            --watermark-gray: #e6e6e6; 
            --link-blue: #2258da;    
            --text-main: #333;       
            --text-meta: #666;
            --status-bar-bg: #EDEEF1; 
            
            --font-main: "Microsoft YaHei", "Segoe UI", sans-serif;
            --font-watermark: "SimSun", "Songti SC", serif; 
        }

        body {
            background-color: #f0f2f5; 
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-main);
            overflow: hidden; 
        }

        /* ================= æ°´å°å±‚ ================= */
        #watermark-layer {
            position: fixed; 
            top: 0; left: -20%; 
            width: 140vw; height: 140vh;
            pointer-events: none; 
            z-index: 9999; 
            mix-blend-mode: multiply; 
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            justify-content: space-around;
        }

        .watermark-item {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--watermark-gray);
            font-family: var(--font-watermark); 
            font-weight: normal; 
            transform: rotate(-30deg);
            white-space: nowrap;
        }

        /* ================= å¼¹çª—å®¹å™¨ ================= */
        .modal-window {
            width: 80%; 
            max-width: 1400px; 
            height: 85vh; 
            background-color: #fff;
            box-shadow: 0 0 30px rgba(0,0,0,0.3); 
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #999; 
            z-index: 10; 
        }

        /* ================= é¡¶éƒ¨ç‹¬ç«‹çŠ¶æ€æ  ================= */
        .window-status-bar {
            height: 30px;
            background-color: var(--status-bar-bg);
            border-bottom: 1px solid #dcdcdc; 
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            padding-right: 10px;
            flex-shrink: 0;
        }

        .win-controls-img {
            width: 110px; height: 24px;
            display: block; background-color: transparent; cursor: pointer;
        }

        /* ================= ç°è‰² Header åŒºåŸŸ ================= */
        .modal-header-gray {
            background-color: var(--bg-gray);
            height: 70px; 
            position: relative;
            flex-shrink: 0;
            border-bottom: 2px solid var(--border-gray);
        }

        .settings-area {
            position: absolute; bottom: 10px; right: 30px;
            text-align: center; font-size: 12px; color: var(--text-meta);
            cursor: pointer;
        }
        
        .settings-icon {
            width: 32px; height: 32px;
            margin: 0 auto 2px;
            background: url('../images/settings.png') no-repeat center/contain;
            display: flex; align-items: center; justify-content: center;
        }

        /* ================= ç™½è‰²å†…å®¹åŒºåŸŸ ================= */
        .modal-content-white {
            background-color: #fff;
            flex: 1;
            padding: 30px 50px;
            overflow-y: auto; 
            position: relative;
        }

        h1.mail-title {
            font-size: 24px; font-weight: normal; margin: 0 0 15px 0; color: #000;
        }

        .meta-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            margin-bottom: 5px; 
        }

        .meta-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mail-meta-line { display: flex; align-items: center; }
        .mailbox-text { font-size: 16px; color: #000; font-weight: normal; }
        .meta-time { font-size: 14px; color: var(--text-meta); margin-left: 20px; font-family: Arial, sans-serif; } 
        .sent-to { font-size: 14px; color: var(--text-meta); }

        .info-actions {
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 5px;
            margin-top: 2px;
            margin-right: 20px; 
        }
        .action-icons { display: flex; gap: 10px; align-items: center;}
        .action-icons img { width: 16px; height: 16px; display: block; cursor: pointer; opacity: 0.7; }
        .action-icons img:hover { opacity: 1; }

        .hide-info-btn { color: var(--link-blue); font-size: 12px; cursor: pointer; text-decoration: none; }
        .hide-info-btn:hover { text-decoration: underline; }

        .info-block {
            background-color: var(--bg-gray);
            padding: 15px 20px;
            font-size: 14px;
            line-height: 1.8;
            position: relative;
            margin-bottom: 25px;
            border-top: 2px solid var(--border-gray);
            border-bottom: 2px solid var(--border-gray);
        }

        .info-row { display: flex; }
        .info-label { color: var(--text-meta); width: 60px; text-align: justify; text-align-last: justify; margin-right: 10px; }
        .info-val { color: var(--text-main); }
        .font-arial { font-family: Arial, sans-serif; }

        .mail-body { font-size: 15px; line-height: 1.6; color: #000; word-break: break-all; }
        .normal-link { color: inherit; text-decoration: none; cursor: text; font-family: Arial, sans-serif; }

        /* ================= å‡çº§ç‰ˆæ§åˆ¶é¢æ¿ (åˆå¹¶æ ·å¼) ================= */
        .control-panel {
            position: fixed; bottom: 20px; right: 20px; background: #fff;
            border: 1px solid #ccc; padding: 0; z-index: 10000;
            width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.15);
            border-radius: 8px; font-size: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }
        
        .control-panel.collapsed {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--link-blue); cursor: pointer;
            border: none;
            display: flex; align-items: center; justify-content: center;
        }
        .control-panel.collapsed .panel-content { opacity: 0; pointer-events: none; }
        .toggle-icon { display: none; color: white; font-size: 24px; }
        .control-panel.collapsed .toggle-icon { display: block; }

        .panel-content { padding: 15px; opacity: 1; transition: opacity 0.3s; }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--link-blue); 
            margin-bottom: 15px; padding-bottom: 8px;
        }
        .panel-header h4 { margin: 0; color: var(--link-blue); font-size: 14px; }

        .minimize-btn { 
            cursor: pointer; font-size: 20px; color: #999; 
            width: 24px; height: 24px; line-height: 20px; text-align: center;
        }
        .minimize-btn:hover { color: #333; background: #eee; border-radius: 4px; }

        .section-title {
            font-weight: bold; color: #666; margin: 15px 0 5px 0; font-size: 12px;
            border-left: 3px solid var(--link-blue); padding-left: 6px;
        }
        .section-title:first-child { margin-top: 0; }

        .control-row { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .control-row label { color: #555; font-weight: bold; width: 70px; }
        .control-row input, .control-row select { flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
        
        .slider-container { flex: 1; display: flex; align-items: center; gap: 5px; }
        .slider-container input { flex: 1; }

        /* æŒ‰é’®ç»„ */
        .btn-full { width: 100%; padding: 6px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-top: 5px; color: #333; }
        .btn-full:hover { background: #e0e0e0; }

        .btn-primary { background: var(--link-blue); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: #ff5252; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* äº‘åŒæ­¥ */
        .cloud-status { font-size: 10px; color: #999; text-align: right; margin-top: 2px; }
        .cloud-status.success { color: green; }
        .cloud-status.error { color: red; }
        .cloud-row { display: flex; gap: 5px; margin-top: 5px; }
        .btn-cloud { flex: 1; font-size: 12px; padding: 5px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-upload { background: #2196F3; } .btn-upload:hover { background: #1976D2; }
        .btn-download { background: #FF9800; } .btn-download:hover { background: #F57C00; }

    </style>
</head>
<body>

    <div id="watermark-layer"></div>

    <div class="modal-window">
        <div class="window-status-bar">
            <img src="../images/window_controls.png" class="win-controls-img" alt="Window Controls">
        </div>

        <div class="modal-header-gray">
            <div class="settings-area">
                <div class="settings-icon"></div>
                è®¾ç½®
            </div>
        </div>

        <div class="modal-content-white">
            <h1 class="mail-title">
                è´·æ¬¾å®¡æ‰¹é€šè¿‡é€šçŸ¥ï¼šè¯·é˜…çŸ¥ï¼šåˆè‚¥<span id="txtBranch">é«˜æ–°ç§‘æŠ€</span>æ”¯è¡Œæœ‰1ç¬”è´·æ¬¾å·²å®Œæˆå®¡æ‰¹
            </h1>

            <div class="meta-header-row">
                <div class="meta-left">
                    <div class="mail-meta-line">
                        <span class="mailbox-text">ä¿¡ç®±: ä¸šåŠ¡æµç¨‹ç®¡ç†å¹³å°</span>
                        <span class="meta-time" id="txtDateTimeTop">2025-12-22 11:28:26</span>
                    </div>
                    <div class="sent-to">
                        å‘é€è‡³ <span id="txtManagerNameTop">åˆ˜ç«‹ä¼Ÿ</span> ;
                    </div>
                </div>

                <div class="info-actions">
                    <div class="action-icons">
                        <img src="../images/icon_chat.png" alt="Chat" title="èŠå¤©">
                        <img src="../images/icon_return.png" alt="Reply" title="å›å¤">
                    </div>
                    <a class="hide-info-btn">éšè—ä¿¡æ¯</a>
                </div>
            </div>

            <div class="info-block">
                <div class="info-row">
                    <span class="info-label">å‘ä»¶äºº</span>
                    <span class="info-val">ä¿¡ç®±ï¼šä¸šåŠ¡æµç¨‹ç®¡ç†å¹³å° &lt;<span id="txtEmailSender">bpmp@spdb.com.cn</span>&gt;</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ”¶ä»¶äºº</span>
                    <span class="info-val">"<span id="txtManagerNameRec">åˆ˜ç«‹ä¼Ÿ</span>" &lt;<span id="txtManagerEmail">llw@spdb.com.cn</span>&gt; ;</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ—¶ é—´</span>
                    <span class="info-val font-arial" id="txtDateTimeMeta">2025-12-22 11:28:26</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¤§ å°</span>
                    <span class="info-val">2.2 KB</span>
                </div>
            </div>

            <div class="mail-body">
                ä¸šåŠ¡å“ç§ï¼šä¸ªäººç”Ÿäº§ç»è¥è´·æ¬¾ã€å€Ÿæ¬¾äººï¼š*<span id="txtCustomerName">é™</span>ã€åˆåŒå·:<span id="txtContract">5801200398453610058</span>ã€é‡‘é¢ï¼š<span id="txtAmount">860000</span>å…ƒï¼Œå·²å®Œæˆå®¡æ‰¹ï¼Œä¸šåŠ¡è¯¦æƒ…è¯·ç™»å½•é›¶å”®ä¿¡è´·æœåŠ¡ç³»ç»Ÿï¼ˆ<span class="normal-link">http://plbs.pbspdb.com/PLBS</span>ï¼‰è¿›è¡ŒæŸ¥è¯¢ã€‚æ³¨ï¼šæ­¤ä¸ºæµ¦å‘é“¶è¡Œé›¶å”®ä¿¡è´·æœåŠ¡ç³»ç»Ÿè‡ªåŠ¨å‘é€çš„æ¶ˆæ¯ï¼Œè¯·å‹¿ç›´æ¥å›å¤
            </div>
        </div>
    </div>

    <div class="control-panel" id="controlPanel" onclick="handlePanelClick(event)">
        <div class="toggle-icon">âš™</div>
        
        <div class="panel-content">
            <div class="panel-header">
                <h4>é‚®ä»¶é…ç½® & æ¡£æ¡ˆ</h4>
                <span class="minimize-btn" onclick="minimizePanel(event)">_</span>
            </div>

            <div class="section-title">é‚®ä»¶å†…å®¹</div>
            <div class="control-row">
                <label>æ”¯è¡Œ</label>
                <select id="selBranch" onchange="updateContent()">
                    <option value="é«˜æ–°ç§‘æŠ€">é«˜æ–°ç§‘æŠ€ (é»˜è®¤)</option>
                    <option value="ç‘¶æµ·">ç‘¶æµ·</option>
                    <option value="å››ç‰Œæ¥¼">å››ç‰Œæ¥¼</option>
                    <option value="æ”¿åŠ¡æ–°åŒº">æ”¿åŠ¡æ–°åŒº</option>
                    <option value="æ»¨æ¹–æ–°åŒº">æ»¨æ¹–æ–°åŒº</option>
                    <option value="å®å›½è·¯">å®å›½è·¯</option>
                </select>
            </div>
            <div class="control-row">
                <label>ç»ç†</label>
                <input type="text" id="inpManager" value="åˆ˜ç«‹ä¼Ÿ" oninput="updateContent()">
            </div>
            <div class="control-row">
                <label>æ‹¼éŸ³</label>
                <input type="text" id="inpPinyin" value="llw" oninput="updateContent()">
            </div>
            <div class="control-row">
                <label>å€Ÿæ¬¾äºº</label>
                <input type="text" id="inpCustomer" value="é™" oninput="updateContent()">
            </div>
            <div class="control-row">
                <label>åˆåŒå·</label>
                <button class="btn-full" style="margin:0; width:auto; flex:1;" onclick="refreshContract()">ğŸ² åˆ·æ–°</button>
            </div>
            <div class="control-row">
                <label>é‡‘é¢</label>
                <input type="text" id="inpAmount" value="860000" oninput="updateContent()">
            </div>
            <div class="control-row">
                <label>æ—¶é—´</label>
                <input type="datetime-local" id="inpDate" step="1" onchange="updateContent()">
            </div>
            
            <div class="section-title">æ°´å°è°ƒèŠ‚</div>
            <div class="control-row">
                <label>å¯†åº¦</label>
                <div class="slider-container">
                    <input type="range" id="inpDensity" min="1.0" max="3.0" step="0.1" value="2.0" oninput="updateContent()">
                    <span id="txtDensity">2.0</span>
                </div>
            </div>
            <div class="control-row">
                <label>å­—å·</label>
                <div class="slider-container">
                    <input type="range" id="inpFontSize" min="24" max="72" step="2" value="48" oninput="updateContent()">
                    <span id="txtFontSize">48</span>
                </div>
            </div>

            <div class="section-title">æœ¬åœ°æ¡£æ¡ˆåº“</div>
            <div class="control-row">
                <input type="text" id="dbSaveName" placeholder="æ¡£æ¡ˆå (è‡ªåŠ¨ç”Ÿæˆ)" style="margin-left:0;">
                <button class="btn-primary" onclick="saveToDB()" style="margin-left:5px;">ä¿å­˜</button>
            </div>
            <div class="control-row">
                <select id="dbList" onchange="loadFromDB()" style="margin-left:0;">
                    <option value="">-- å†å²è®°å½• --</option>
                </select>
                <button class="btn-danger" onclick="deleteFromDB()" style="margin-left:5px;">åˆ </button>
            </div>

            <div class="section-title">GitHub äº‘åŒæ­¥</div>
            <div class="control-row">
                <input type="password" id="ghToken" placeholder="ç²˜è´´ Token" onchange="saveToken()" style="margin-left:0;">
            </div>
            <div class="cloud-status" id="cloudStatus">æœªé…ç½®</div>
            <div class="cloud-row">
                <button class="btn-cloud btn-upload" onclick="syncToCloud('upload')">â¬† ä¸Šä¼ åˆ°äº‘</button>
                <button class="btn-cloud btn-download" onclick="syncToCloud('download')">â¬‡ ä»äº‘ä¸‹è½½</button>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            // åˆå§‹åŒ–æ—¶é—´
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const HH = String(now.getHours()).padStart(2, '0');
            const MM = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            const nowStr = `${yyyy}-${mm}-${dd}T${HH}:${MM}:${ss}`;
            
            document.getElementById('inpDate').value = nowStr;
            updateContent();

            // æ•°æ®åº“åˆå§‹åŒ–
            refreshList();

            // Token åˆå§‹åŒ–
            const savedToken = localStorage.getItem('GH_TOKEN');
            if(savedToken) {
                document.getElementById('ghToken').value = savedToken;
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        };

        // UI äº¤äº’
        function handlePanelClick(e) {
            const panel = document.getElementById('controlPanel');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
            }
        }
        function minimizePanel(e) {
            e.stopPropagation(); 
            document.getElementById('controlPanel').classList.add('collapsed');
        }
        function toggleControlPanel() {
            document.getElementById('controlPanel').classList.toggle('collapsed');
        }

        // ä¸šåŠ¡é€»è¾‘
        function refreshContract() {
            const prefix = "5801200";
            let suffix = "";
            for(let i=0; i<12; i++) {
                suffix += Math.floor(Math.random() * 10);
            }
            document.getElementById('txtContract').innerText = prefix + suffix;
        }

        function updateContent() {
            const branch = document.getElementById('selBranch').value;
            const manager = document.getElementById('inpManager').value;
            const pinyin = document.getElementById('inpPinyin').value;
            const customer = document.getElementById('inpCustomer').value;
            const amount = document.getElementById('inpAmount').value;
            const dateStrRaw = document.getElementById('inpDate').value;
            const density = parseFloat(document.getElementById('inpDensity').value);
            const fontSize = parseInt(document.getElementById('inpFontSize').value);
            
            document.getElementById('txtDensity').innerText = density;
            document.getElementById('txtFontSize').innerText = fontSize;

            let formattedDate = "";
            let dateForWatermark = "";
            if(dateStrRaw) {
                const d = new Date(dateStrRaw);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const HH = String(d.getHours()).padStart(2, '0');
                const MM = String(d.getMinutes()).padStart(2, '0');
                const ss = String(d.getSeconds()).padStart(2, '0');
                formattedDate = `${yyyy}-${mm}-${dd} ${HH}:${MM}:${ss}`;
                dateForWatermark = `${yyyy}-${mm}-${dd}`;
            }

            document.getElementById('txtBranch').innerText = branch;
            document.getElementById('txtManagerNameTop').innerText = manager;
            document.getElementById('txtManagerNameRec').innerText = manager;
            document.getElementById('txtManagerEmail').innerText = pinyin + "@spdb.com.cn";
            document.getElementById('txtCustomerName').innerText = customer;
            document.getElementById('txtAmount').innerText = amount;
            document.getElementById('txtDateTimeTop').innerText = formattedDate;
            document.getElementById('txtDateTimeMeta').innerText = formattedDate;

            updateWatermark(pinyin, dateForWatermark, density, fontSize);
        }

        function updateWatermark(pinyin, dateStr, density, fontSize) {
            const container = document.getElementById('watermark-layer');
            container.innerHTML = ''; 
            const text = `æµ¦å‘é“¶è¡Œ ${pinyin.toUpperCase()} ${dateStr}`;
            const baseW = 400; const baseH = 200;
            const itemW = baseW * density; const itemH = baseH * density;
            const winW = window.innerWidth; const winH = window.innerHeight;
            const cols = Math.ceil(winW / itemW) + 2;
            const rows = Math.ceil(winH / itemH) + 2;
            const total = cols * rows;

            for(let i=0; i<total; i++) {
                const div = document.createElement('div');
                div.className = 'watermark-item';
                div.innerText = text;
                div.style.width = itemW + 'px';
                div.style.height = itemH + 'px';
                div.style.fontSize = fontSize + 'px'; 
                container.appendChild(div);
            }
        }
        
        window.addEventListener('resize', () => { updateContent(); });

        /* ================= æ•°æ®åº“ & äº‘åŒæ­¥ ================= */
        // æ³¨æ„ï¼šè¿™é‡ŒåŠ å…¥äº† txtContractï¼Œå®ƒæ˜¯ spanï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        const fieldIds = [
            'selBranch', 'inpManager', 'inpPinyin', 'inpCustomer', 
            'txtContract', 'inpAmount', 'inpDate', 'inpDensity', 'inpFontSize'
        ];
        
        const DB_KEY = "SPDB_BANK_DB";
        const GIST_FILENAME = "spdb_bank_db.json";
        const GIST_DESC = "SPDB System Database Backup";

        function saveToDB() {
            const custName = document.getElementById('inpCustomer').value.trim() || "æœªå‘½å";
            const now = new Date();
            const timeStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            
            let saveName = document.getElementById('dbSaveName').value.trim();
            if(!saveName) saveName = `${custName}_${timeStr}`;

            const data = {};
            fieldIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    if(el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                        data[id] = el.value;
                    } else {
                        // é’ˆå¯¹ span (åˆåŒå·)
                        data[id] = el.innerText;
                    }
                }
            });

            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            allData[saveName] = data;
            localStorage.setItem(DB_KEY, JSON.stringify(allData));

            alert(`âœ… å·²ä¿å­˜åˆ°æœ¬åœ°: ${saveName}`);
            refreshList();
            document.getElementById('dbSaveName').value = "";
        }

        function loadFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            const data = allData[name];
            if(data) {
                fieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el && data[id] !== undefined) {
                        if(el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                            el.value = data[id];
                        } else {
                            el.innerText = data[id];
                        }
                    }
                });
                // è¯»å–æ•°æ®åï¼Œå¿…é¡»åˆ·æ–°é¡µé¢å†…å®¹å’Œæ°´å°
                updateContent();
            }
        }

        function deleteFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            if(!confirm(`åˆ é™¤ [${name}] ?`)) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            delete allData[name];
            localStorage.setItem(DB_KEY, JSON.stringify(allData));
            refreshList();
        }

        function refreshList() {
            const select = document.getElementById('dbList');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- å†å²è®°å½• --</option>';
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            Object.keys(allData).reverse().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                select.appendChild(opt);
            });
            if(allData[currentVal]) select.value = currentVal;
        }

        function saveToken() {
            const token = document.getElementById('ghToken').value.trim();
            if(token) {
                localStorage.setItem('GH_TOKEN', token);
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        }

        async function syncToCloud(action) {
            const token = localStorage.getItem('GH_TOKEN');
            if(!token) {
                alert("è¯·å…ˆè¾“å…¥ GitHub Tokenï¼");
                return;
            }
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerText = "æ­£åœ¨è¿æ¥...";
            statusDiv.className = "cloud-status";

            try {
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `token ${token}` }
                });
                if(!userRes.ok) throw new Error("Token æ— æ•ˆ");
                
                const gistsRes = await fetch('https://api.github.com/gists', {
                    headers: { Authorization: `token ${token}` }
                });
                const gists = await gistsRes.json();
                
                let targetGist = gists.find(g => g.description === GIST_DESC && g.files[GIST_FILENAME]);
                let gistId = targetGist ? targetGist.id : null;

                if (action === 'upload') {
                    const content = localStorage.getItem(DB_KEY) || "{}";
                    const payload = {
                        description: GIST_DESC,
                        public: false,
                        files: { [GIST_FILENAME]: { content: content } }
                    };
                    let url = 'https://api.github.com/gists';
                    let method = 'POST';
                    if (gistId) {
                        url += `/${gistId}`;
                        method = 'PATCH';
                    }
                    await fetch(url, {
                        method: method,
                        headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    statusDiv.innerText = "âœ… ä¸Šä¼ æˆåŠŸ";
                    statusDiv.classList.add("success");
                    alert("äº‘ç«¯åŒæ­¥å®Œæˆï¼");

                } else if (action === 'download') {
                    if (!gistId) {
                        alert("äº‘ç«¯æ— å¤‡ä»½ï¼");
                        statusDiv.innerText = "äº‘ç«¯æ— æ–‡ä»¶";
                        return;
                    }
                    const detailRes = await fetch(`https://api.github.com/gists/${gistId}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    const detail = await detailRes.json();
                    const content = detail.files[GIST_FILENAME].content;
                    localStorage.setItem(DB_KEY, content);
                    refreshList();
                    statusDiv.innerText = "âœ… ä¸‹è½½æˆåŠŸ";
                    statusDiv.classList.add("success");
                    alert("æ•°æ®å·²æ¢å¤ï¼");
                }
            } catch (error) {
                statusDiv.innerText = "âŒ " + error.message;
                statusDiv.classList.add("error");
            }
        }
    </script>
</body>
</html>