<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½é“¶è¡Œ - ç­¾ç½²æ„è§</title>
    <style>
        :root {
            --font-song: "SimSun", "Songti SC", serif;
            --font-yahei: "Microsoft YaHei", "Segoe UI", sans-serif;
            --border-color: #000;
            --text-color: #000;
            --theme-color: #b71c1c; /* ä¸­è¡Œçº¢ */
        }

        @page { size: A4; margin: 0; }

        body {
            background-color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
            font-family: var(--font-song); 
        }

        .a4-page {
            background: white;
            width: 210mm;
            height: 297mm;
            padding: 15mm 15mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }

        @media print {
            body { background: none; padding: 0; }
            .a4-page {
                box-shadow: none;
                width: 210mm; height: 297mm;
                margin: 0; padding: 15mm 15mm;
                page-break-after: always;
            }
            .control-panel, .print-btn-float { display: none !important; }
            -webkit-print-color-adjust: exact;
        }

        /* ä»¿çœŸé¡µçœ‰é¡µè„š */
        .fake-header {
            position: absolute; top: 5mm; left: 10mm; right: 10mm;
            display: flex; justify-content: space-between;
            font-size: 16px; color: #000; font-family: var(--font-song);
        }
        .fake-footer {
            position: absolute; bottom: 5mm; left: 10mm; right: 10mm;
            display: flex; justify-content: space-between;
            font-size: 16px; color: #000; font-family: var(--font-song);
        }

        .content-wrapper { margin-top: 35px; }

        .sub-header {
            display: flex; justify-content: space-between;
            font-size: 12px; border-bottom: 1px solid #000;
            padding-bottom: 5px; margin-bottom: 30px;
            font-family: var(--font-yahei);
            padding-left: 2em; padding-right: 2em;
        }

        .main-title {
            text-align: center; font-weight: bold; font-size: 14px;
            margin-bottom: 20px; font-family: var(--font-yahei);
        }

        /* è¡¨æ ¼é€šç”¨æ ·å¼ */
        table {
            width: 100%; border-collapse: collapse; margin-bottom: 25px;
            table-layout: fixed; 
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 4px 2px;
            text-align: center; vertical-align: middle;
            font-size: 10px;
            font-family: var(--font-song);
            word-wrap: break-word;
        }

        tr { height: 36px; }

        .section-header-row td {
            text-align: left; padding-left: 0;
            border: 1px solid var(--border-color);
            background-color: #fff; height: 30px;
        }

        .section-title-container {
            display: flex; align-items: center;
            font-family: var(--font-yahei); font-weight: bold;
            font-size: 14px; padding-left: 5px;
        }

        .icon-img { width: 16px; height: 16px; display: block; z-index: 1; }
        .title-text { position: relative; z-index: 2; margin-left: -6px; background: transparent; }
        .align-left { text-align: left !important; padding-left: 10px; }
        thead th { font-weight: normal; font-size: 10px; font-family: var(--font-song); }

        /* æ°´å° */
        #watermark-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 99;
            overflow: hidden; display: flex; flex-wrap: wrap; align-content: flex-start;
        }
        .watermark-item {
            display: flex; align-items: center; justify-content: center;
            color: rgba(200, 200, 200, 0.35); font-weight: normal;
            transform: rotate(-30deg); white-space: nowrap; font-family: var(--font-yahei);
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            position: fixed; bottom: 20px; right: 20px; background: #fff;
            border: 1px solid #ccc; padding: 0; z-index: 10000;
            width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.15);
            border-radius: 8px; font-size: 12px; font-family: var(--font-yahei);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            max-height: 80vh; overflow-y: auto;
        }
        
        .control-panel.collapsed {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--theme-color); cursor: pointer;
            border: none; display: flex; align-items: center; justify-content: center;
        }
        .control-panel.collapsed .panel-content { opacity: 0; pointer-events: none; }
        .toggle-icon { display: none; color: white; font-size: 24px; }
        .control-panel.collapsed .toggle-icon { display: block; }

        .panel-content { padding: 15px; opacity: 1; transition: opacity 0.3s; }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--theme-color); 
            margin-bottom: 15px; padding-bottom: 8px;
        }
        .panel-header h4 { margin: 0; color: var(--theme-color); font-size: 14px; }

        .minimize-btn { 
            cursor: pointer; font-size: 20px; color: #999; 
            width: 24px; height: 24px; line-height: 20px; text-align: center;
        }
        .minimize-btn:hover { color: #333; background: #eee; border-radius: 4px; }

        .section-title {
            font-weight: bold; color: #666; margin: 15px 0 5px 0; font-size: 12px;
            border-left: 3px solid var(--theme-color); padding-left: 6px;
        }
        .section-title:first-child { margin-top: 0; }

        .control-row { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .control-row label { color: #555; font-weight: bold; width: 70px; }
        .control-row input, .control-row select { flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px; margin-left: 5px;}
        .slider-container { flex: 1; display: flex; align-items: center; gap: 5px; margin-left: 5px; }
        .slider-container input { flex: 1; }

        .btn-full { width: 100%; padding: 6px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-top: 5px; color: #333; }
        .btn-full:hover { background: #e0e0e0; }
        .btn-primary { background: var(--theme-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: #ff5252; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        .cloud-status { font-size: 10px; color: #999; text-align: right; margin-top: 2px; }
        .cloud-status.success { color: green; }
        .cloud-status.error { color: red; }
        .cloud-row { display: flex; gap: 5px; margin-top: 5px; }
        .btn-cloud { flex: 1; font-size: 12px; padding: 5px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-upload { background: #2196F3; } .btn-upload:hover { background: #1976D2; }
        .btn-download { background: #FF9800; } .btn-download:hover { background: #F57C00; }

        .print-btn-float {
            position: fixed; top: 20px; right: 20px; padding: 10px 20px;
            background: var(--theme-color); color: #fff; border: none; border-radius: 4px;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 14px; font-family: var(--font-yahei); z-index: 10001;
        }
        .print-btn-float:hover { background: #d32f2f; }

    </style>
</head>
<body>

    <button class="print-btn-float" onclick="window.print()">ğŸ–¨ï¸ æ‰“å° / ä¸‹è½½PDF</button>

    <div class="a4-page">
        <div class="fake-header">
            <span>RLMS</span>
            <span>é¡µç ï¼Œ1/1</span>
        </div>

        <div id="watermark-layer"></div>

        <div class="content-wrapper">
            <div class="sub-header">
                <span>å½“å‰ä½ç½®ï¼šç­¾ç½²æ„è§</span>
                <span>å½“å‰æµæ°´å·ï¼š<span id="txtSerialHeader">2018632086193</span></span>
            </div>

            <div class="main-title">ç­¾ç½²æ„è§</div>

            <table>
                <colgroup>
                    <col style="width: 28.5%"> <col style="width: 14.3%"> <col style="width: 14.3%"> <col style="width: 28.5%"> <col style="width: 14.4%"> </colgroup>
                <tr class="section-header-row">
                    <td colspan="5">
                        <div class="section-title-container">
                            <img src="../images/icon_doc.svg" class="icon-img" alt="">
                            <span class="title-text">æµæ°´ä¿¡æ¯</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>å·¥ä½œæµæ°´</td>
                    <td>æµæ°´ç±»å‹</td>
                    <td>å€Ÿæ¬¾äºº</td>
                    <td>è´·æ¬¾é‡‘é¢</td>
                    <td>ç»åŠ</td>
                </tr>
                <tr>
                    <td id="txtSerialTable">2018632086193</td>
                    <td>è´·æ¬¾</td>
                    <td id="txtBorrowerTable">ä¸¥ä»ç²</td>
                    <td id="txtAmountTable">CNY 4,800,000.00</td>
                    <td id="txtHandlerTable">9235394</td>
                </tr>
            </table>

            <table>
                <colgroup>
                    <col style="width: 42.8%"> 
                    <col style="width: 42.8%">
                    <col style="width: 14.4%">
                </colgroup>
                <tr class="section-header-row">
                    <td colspan="3">
                        <div class="section-title-container">
                            <img src="../images/icon_doc.svg" class="icon-img" alt="">
                            <span class="title-text">é£é™©ä¿¡æ¯</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>æŸ¥çœ‹é£é™©é¢„è­¦ä¿¡æ¯</td>
                    <td>é£é™©é¢„è­¦ä¿¡æ¯å·²é˜…</td>
                    <td></td> </tr>
            </table>

            <table>
                <colgroup>
                    <col style="width: 42.8%">
                    <col style="width: 57.2%">
                </colgroup>
                <tr class="section-header-row">
                    <td colspan="2">
                        <div class="section-title-container">
                            <img src="../images/icon_doc.svg" class="icon-img" alt="">
                            <span class="title-text">è´·å‰è°ƒæŸ¥å®¡æ ¸æ„è§</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>è´·å‰è°ƒæŸ¥</td>
                    <td class="align-left" style="height: 40px;"></td>
                </tr>
                <tr>
                    <td>è´·å‰è°ƒæŸ¥æ ¸æ„è§</td>
                    <td class="align-left">åŒæ„</td>
                </tr>
            </table>

            <table>
                <colgroup>
                    <col style="width: 28.5%">
                    <col style="width: 28.6%"> <col style="width: 28.5%"> <col style="width: 14.4%">
                </colgroup>
                <tr class="section-header-row">
                    <td colspan="4">
                        <div class="section-title-container">
                            <img src="../images/icon_doc.svg" class="icon-img" alt="">
                            <span class="title-text">æ„è§ä¿¡æ¯</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>ç”³è¯·å€Ÿæ¬¾é‡‘é¢(å…ƒ)ï¼š</td>
                    <td class="align-left" id="txtAmountRaw">4800000</td>
                    <td>è´·æ¬¾æœŸé™(æœˆ)ï¼š</td>
                    <td class="align-left" id="txtTermTable">120</td>
                </tr>
                <tr>
                    <td>æ”¾æ¬¾å‰æ¡ä»¶ï¼š</td>
                    <td colspan="3" class="align-left" style="height: 50px; vertical-align: top;"><p></p>â– æŠµæŠ¼åˆåŒç­¾ç½²</td>
                </tr>
                <tr>
                    <td>å®¡æ‰¹ç»“è®º</td>
                    <td colspan="3" class="align-left" style="height: 40px;">åŒæ„</td>
                </tr>
            </table>
        </div>

        <div class="fake-footer">
            <span style="font-family: Arial;">http://21.123.93.107/RLMS/retailCreditSign.do</span>
            <span style="font-family: Arial;" id="txtFooterDate">2025/11/07</span>
        </div>
    </div>

    <div class="control-panel" id="controlPanel" onclick="handlePanelClick(event)">
        <div class="toggle-icon">âš™</div>
        
        <div class="panel-content">
            <div class="panel-header">
                <h4>è®¾ç½®ä¸æ¡£æ¡ˆ</h4>
                <span class="minimize-btn" onclick="minimizePanel(event)">_</span>
            </div>

            <div class="section-title">å†…å®¹è®¾ç½®</div>
            <div class="control-row">
                <label>å€Ÿæ¬¾äºº</label>
                <input type="text" id="inpBorrower" value="ä¸¥ä»ç²" oninput="updateContent()">
            </div>
            <div class="control-row">
                <label>é‡‘é¢</label>
                <input type="number" id="inpAmount" value="4800000" oninput="updateContent()">
            </div>
            <div class="control-row">
                <label>æœŸé™(æœˆ)</label>
                <select id="selTerm" onchange="updateContent()">
                    <option value="12">12</option>
                    <option value="24">24</option>
                    <option value="36">36</option>
                    <option value="60">60</option>
                    <option value="120" selected>120</option>
                    <option value="360">360</option>
                </select>
            </div>
            
            <div class="section-title">æ—¶é—´è®¾ç½®</div>
            <div class="control-row">
                <label>æ‰“å°æ—¥æœŸ</label>
                <input type="date" id="inpDatePrint" onchange="updateContent()">
            </div>
            <div class="control-row">
                <label>æµæ°´æ—¥æœŸ</label>
                <input type="date" id="inpDateWatermark" onchange="updateContent()">
            </div>

            <div class="section-title">ç¼–å·ç”Ÿæˆ</div>
            <div class="control-row">
                <label>æµæ°´å·</label>
                <button class="btn-full" style="width:auto; flex:1; margin:0;" onclick="refreshSerial()">ğŸ² åˆ·æ–°</button>
            </div>
            <div class="control-row">
                <label>ç»åŠäºº</label>
                <button class="btn-full" style="width:auto; flex:1; margin:0;" onclick="refreshHandler()">ğŸ² åˆ·æ–°</button>
            </div>
            <input type="hidden" id="inpSerialHidden">
            <input type="hidden" id="inpHandlerHidden">

            <div class="section-title">æ°´å°è°ƒèŠ‚</div>
            <div class="control-row">
                <label>å¯†åº¦</label>
                <div class="slider-container">
                    <input type="range" id="inpDensity" min="0.5" max="3.0" step="0.1" value="0.7" oninput="updateContent()">
                    <span id="txtDensity">0.7</span>
                </div>
            </div>
            <div class="control-row">
                <label>å­—å·</label>
                <div class="slider-container">
                    <input type="range" id="inpFontSize" min="12" max="36" step="1" value="13" oninput="updateContent()">
                    <span id="txtFontSize">13</span>
                </div>
            </div>

            <div class="section-title">æœ¬åœ°æ¡£æ¡ˆåº“</div>
            <div class="control-row">
                <input type="text" id="dbSaveName" placeholder="æ¡£æ¡ˆå (è‡ªåŠ¨ç”Ÿæˆ)" style="margin-left:0;">
                <button class="btn-primary" onclick="saveToDB()" style="margin-left:5px;">ä¿å­˜</button>
            </div>
            <div class="control-row">
                <select id="dbList" onchange="loadFromDB()" style="margin-left:0;">
                    <option value="">-- å†å²è®°å½• --</option>
                </select>
                <button class="btn-danger" onclick="deleteFromDB()" style="margin-left:5px;">åˆ </button>
            </div>

            <div class="section-title">GitHub äº‘åŒæ­¥</div>
            <div class="control-row">
                <input type="password" id="ghToken" placeholder="ç²˜è´´ Token" onchange="saveToken()" style="margin-left:0;">
            </div>
            <div class="cloud-status" id="cloudStatus">æœªé…ç½®</div>
            <div class="cloud-row">
                <button class="btn-cloud btn-upload" onclick="syncToCloud('upload')">â¬† ä¸Šä¼ åˆ°äº‘</button>
                <button class="btn-cloud btn-download" onclick="syncToCloud('download')">â¬‡ ä»äº‘ä¸‹è½½</button>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½®ä¸å­˜æ¡£é”®å (æ›´æ–°æ—¥æœŸå­—æ®µ) ===
        const fieldIds = [
            "inpBorrower", "inpAmount", "selTerm", "inpDensity", "inpFontSize", 
            "inpDatePrint", "inpDateWatermark", // åŒæ—¥æœŸ
            "inpSerialHidden", "inpHandlerHidden"
        ];
        const DB_KEY = "BOC_BANK_DB";
        const GIST_FILENAME = "boc_bank_db.json";
        const GIST_DESC = "BOC System Database Backup";
        const AUTO_SAVE_KEY = "BOC_LAST_SESSION";

        window.onload = function() {
            // 1. åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            
            document.getElementById('inpDatePrint').value = todayStr;
            document.getElementById('inpDateWatermark').value = todayStr;

            // 2. åˆå§‹åŒ–é»˜è®¤å€¼
            if(!document.getElementById('inpSerialHidden').value) refreshSerial();
            if(!document.getElementById('inpHandlerHidden').value) refreshHandler();

            // 3. å°è¯•åŠ è½½è‡ªåŠ¨ä¿å­˜ (ä¼šè¦†ç›–ä¸Šé¢çš„é»˜è®¤å€¼)
            loadLastState();

            // 4. åˆ·æ–°è§†å›¾
            updateContent();

            // 5. åˆå§‹åŒ–æ•°æ®åº“å’ŒToken
            refreshList();
            const savedToken = localStorage.getItem('GH_TOKEN');
            if(savedToken) {
                document.getElementById('ghToken').value = savedToken;
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        };

        // å…¨å±€è‡ªåŠ¨ä¿å­˜ç›‘å¬
        document.addEventListener('input', () => { saveCurrentState(); });
        document.addEventListener('change', () => { saveCurrentState(); });

        // --- UI é€»è¾‘ ---
        function handlePanelClick(e) {
            const panel = document.getElementById('controlPanel');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
            }
        }
        function minimizePanel(e) {
            e.stopPropagation(); 
            document.getElementById('controlPanel').classList.add('collapsed');
        }
        function toggleControlPanel() {
            document.getElementById('controlPanel').classList.toggle('collapsed');
        }

        function refreshSerial() {
            const year = new Date().getFullYear();
            let random9 = "";
            for(let i=0; i<9; i++) { random9 += Math.floor(Math.random() * 10); }
            const serial = year + random9;
            document.getElementById('inpSerialHidden').value = serial;
            updateContent();
            saveCurrentState(); 
        }

        function refreshHandler() {
            let random6 = "";
            for(let i=0; i<6; i++) { random6 += Math.floor(Math.random() * 10); }
            const handler = "9" + random6;
            document.getElementById('inpHandlerHidden').value = handler;
            updateContent();
            saveCurrentState();
        }

        function updateContent() {
            const borrower = document.getElementById('inpBorrower').value;
            const amount = document.getElementById('inpAmount').value;
            const term = document.getElementById('selTerm').value;
            const density = parseFloat(document.getElementById('inpDensity').value);
            const fontSize = parseInt(document.getElementById('inpFontSize').value);
            const datePrint = document.getElementById('inpDatePrint').value;
            const dateWatermark = document.getElementById('inpDateWatermark').value;
            
            const serial = document.getElementById('inpSerialHidden').value || "2018632086193";
            const handler = document.getElementById('inpHandlerHidden').value || "9235394";

            document.getElementById('txtDensity').innerText = density;
            document.getElementById('txtFontSize').innerText = fontSize;
            document.getElementById('txtBorrowerTable').innerText = borrower;
            
            document.getElementById('txtSerialHeader').innerText = serial;
            document.getElementById('txtSerialTable').innerText = serial;

            const moneyFloat = parseFloat(amount);
            if (!isNaN(moneyFloat)) {
                const formatted = moneyFloat.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                document.getElementById('txtAmountTable').innerText = "CNY " + formatted;
                document.getElementById('txtAmountRaw').innerText = amount;
            }

            document.getElementById('txtTermTable').innerText = term;
            document.getElementById('txtHandlerTable').innerText = handler;
            
            // æ›´æ–°é¡µè„šæ—¥æœŸ
            if(datePrint) {
                const d = new Date(datePrint);
                const footerStr = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
                document.getElementById('txtFooterDate').innerText = footerStr;
            }

            // æ›´æ–°æ°´å°æ—¥æœŸå­—ç¬¦ä¸² (YYYYMMDD)
            let wmDateStr = "";
            if(dateWatermark) {
                const d = new Date(dateWatermark);
                wmDateStr = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
            }

            // æ›´æ–°æ°´å°
            updateWatermark(handler, density, fontSize, wmDateStr);
        }

        function updateWatermark(handler, density, fontSize, dateStr) {
            const container = document.getElementById('watermark-layer');
            container.innerHTML = ''; 
            
            const text = `${handler} ${dateStr}`;
            
            const baseWidthPercent = 33.3;
            let itemWidthPercent = baseWidthPercent * density;
            if (itemWidthPercent > 100) itemWidthPercent = 100;
            const total = 50; 

            for(let i=0; i<total; i++) {
                const div = document.createElement('div');
                div.className = 'watermark-item';
                div.innerText = text;
                div.style.width = itemWidthPercent + '%'; 
                div.style.fontSize = fontSize + 'px';
                div.style.height = '150px'; 
                container.appendChild(div);
            }
        }

        // --- å­˜æ¡£ & äº‘åŒæ­¥æ ¸å¿ƒé€»è¾‘ ---
        
        function saveCurrentState() {
            const data = {};
            fieldIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) data[id] = el.value;
            });
            localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
        }

        function loadLastState() {
            const saved = localStorage.getItem(AUTO_SAVE_KEY);
            if(saved) {
                const data = JSON.parse(saved);
                fieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el && data[id] !== undefined) el.value = data[id];
                });
            }
        }

        function saveToDB() {
            const custName = document.getElementById('inpBorrower').value.trim() || "æœªå‘½å";
            const now = new Date();
            const timeStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}`;
            
            let saveName = document.getElementById('dbSaveName').value.trim();
            if(!saveName) saveName = `${custName}_${timeStr}`;

            const data = {};
            fieldIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) data[id] = el.value;
            });

            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            allData[saveName] = data;
            localStorage.setItem(DB_KEY, JSON.stringify(allData));

            alert(`âœ… å·²ä¿å­˜: ${saveName}`);
            refreshList();
            document.getElementById('dbSaveName').value = "";
        }

        function loadFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            const data = allData[name];
            if(data) {
                fieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el && data[id] !== undefined) el.value = data[id];
                });
                updateContent();
            }
        }

        function deleteFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            if(!confirm(`åˆ é™¤ [${name}] ?`)) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            delete allData[name];
            localStorage.setItem(DB_KEY, JSON.stringify(allData));
            refreshList();
        }

        function refreshList() {
            const select = document.getElementById('dbList');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- å†å²è®°å½• --</option>';
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            Object.keys(allData).reverse().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                select.appendChild(opt);
            });
            if(allData[currentVal]) select.value = currentVal;
        }

        function saveToken() {
            const token = document.getElementById('ghToken').value.trim();
            if(token) {
                localStorage.setItem('GH_TOKEN', token);
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        }

        async function syncToCloud(action) {
            const token = localStorage.getItem('GH_TOKEN');
            if(!token) { alert("è¯·å…ˆè¾“å…¥ GitHub Tokenï¼"); return; }
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerText = "è¿æ¥ä¸­...";
            statusDiv.className = "cloud-status";

            try {
                const userRes = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${token}` } });
                if(!userRes.ok) throw new Error("Token æ— æ•ˆ");

                const gistsRes = await fetch('https://api.github.com/gists', { headers: { Authorization: `token ${token}` } });
                const gists = await gistsRes.json();
                let targetGist = gists.find(g => g.description === GIST_DESC && g.files[GIST_FILENAME]);
                let gistId = targetGist ? targetGist.id : null;

                if (action === 'upload') {
                    const content = localStorage.getItem(DB_KEY) || "{}";
                    const payload = { description: GIST_DESC, public: false, files: { [GIST_FILENAME]: { content: content } } };
                    let url = 'https://api.github.com/gists';
                    let method = 'POST';
                    if (gistId) { url += `/${gistId}`; method = 'PATCH'; }
                    
                    await fetch(url, { method: method, headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    statusDiv.innerText = "âœ… ä¸Šä¼ æˆåŠŸ"; statusDiv.classList.add("success"); alert("åŒæ­¥å®Œæˆ");

                } else if (action === 'download') {
                    if (!gistId) { alert("äº‘ç«¯æ— æ–‡ä»¶"); return; }
                    const detailRes = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { Authorization: `token ${token}` } });
                    const detail = await detailRes.json();
                    localStorage.setItem(DB_KEY, detail.files[GIST_FILENAME].content);
                    refreshList();
                    loadFromDB(); // è‡ªåŠ¨åŠ è½½æœ€æ–°
                    statusDiv.innerText = "âœ… ä¸‹è½½æˆåŠŸ"; statusDiv.classList.add("success"); alert("å·²æ¢å¤");
                }
            } catch (error) {
                statusDiv.innerText = "âŒ " + error.message; statusDiv.classList.add("error");
            }
        }
    </script>
</body>
</html>