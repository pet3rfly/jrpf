<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆè‚¥å¸‚ä¸åŠ¨äº§ç™»è®°ä¿¡æ¯æŸ¥è¯¢ç»“æœ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --font-song: "SimSun", "Songti SC", serif;
            --font-hei: "SimHei", "Heiti SC", sans-serif;
            --border-color: #000;
            --theme-color: #2258da;
        }

        @page { size: A4; margin: 0; }

        body {
            background-color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: var(--font-song);
            color: #000;
        }

        .a4-page {
            background: white;
            width: 210mm;
            height: 297mm;
            padding: 25mm 5mm 5mm 5mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }

        @media print {
            body { background: none; padding: 0; }
            .a4-page {
                box-shadow: none;
                width: 210mm; height: 297mm;
                padding: 25mm 5mm 5mm 5mm;
                margin: 0;
                page-break-after: always;
            }
            .control-panel, .btn-group { display: none !important; }
            -webkit-print-color-adjust: exact;
        }

        #bg-watermark {
            position: absolute; top: 40px; left: 0px; width: 100%; height: 100%;
            z-index: 0; object-fit: cover; pointer-events: none; opacity: 0.8;
        }
        #stamp-layer {
            position: absolute; z-index: 5;
            width: 160px; top: 350px; left: 400px;
            pointer-events: none; mix-blend-mode: multiply; transform: rotate(-15deg);
        }
        .content-layer {
            position: relative; z-index: 10; background: transparent; 
        }

        .header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 20px;
        }
        .header-title { text-align: center; width: 100%; padding-left: 120px; }
        .header-title h1 {
            font-size: 22px; font-weight: bold; font-family: var(--font-hei);
            margin: 0 0 15px 0; letter-spacing: 1px;
        }
        .header-info { font-size: 16px; text-align: left; margin: 0; }
        .qr-code { width: 120px; height: 120px; object-fit: contain; }

        .section-title {
            font-size: 16px; 
            font-weight: normal; 
            margin: 10px 0 2px 0;
            font-family: var(--font-song);
        }

        table {
            width: 100%; border-collapse: collapse; margin-bottom: 2px;
            table-layout: fixed; 
            font-size: 16px; 
            background: transparent;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 2px 1px;
            text-align: center; 
            vertical-align: middle;
            line-height: 1.1; word-break: break-all;
            font-weight: normal;
        }
        
        td[contenteditable="true"] { outline: none; }
        [contenteditable="true"]:hover { background-color: rgba(255, 255, 0, 0.1); cursor: text; }
        [contenteditable="true"]:focus { background-color: rgba(255, 255, 255, 0.8); }

        .footer-date {
            text-align: right; font-size: 16px;
            margin-top: 8px; margin-bottom: 5px;
            margin-right: 4em;
        }
        .footer-notes { font-size: 16px; line-height: 1.4; color: #333; margin-top: 5px; }

        .btn-group {
            position: fixed; top: 20px; right: 20px; z-index: 10001;
            display: flex; gap: 10px;
        }
        .float-btn {
            padding: 8px 15px; background: var(--theme-color); color: #fff;
            border: none; border-radius: 4px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 14px;
            font-family: "Microsoft YaHei";
        }
        .float-btn.green { background: #28a745; }
        .float-btn:hover { opacity: 0.9; }

        /* === ç»Ÿä¸€æ§åˆ¶é¢æ¿æ ·å¼ === */
        .control-panel {
            position: fixed; bottom: 20px; right: 20px; background: #fff;
            border: 1px solid #ccc; padding: 0; z-index: 10000;
            width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.15);
            border-radius: 8px; font-size: 12px; font-family: "Microsoft YaHei";
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            max-height: 80vh; /* é˜²æ­¢å¤ªé«˜ */
            overflow-y: auto;
        }
        
        .control-panel.collapsed {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--theme-color); cursor: pointer;
            border: none; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .control-panel.collapsed .panel-content { opacity: 0; pointer-events: none; }
        .toggle-icon { display: none; color: white; font-size: 24px; }
        .control-panel.collapsed .toggle-icon { display: block; }

        .panel-content { padding: 15px; opacity: 1; transition: opacity 0.3s; }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--theme-color); 
            margin-bottom: 15px; padding-bottom: 8px;
        }
        .panel-header h4 { margin: 0; color: var(--theme-color); font-size: 14px; }

        .minimize-btn { 
            cursor: pointer; font-size: 20px; color: #999; 
            width: 24px; height: 24px; line-height: 20px; text-align: center;
        }
        .minimize-btn:hover { color: #333; background: #eee; border-radius: 4px; }

        .section-title {
            font-weight: bold; color: #666; margin: 15px 0 5px 0; font-size: 12px;
            border-left: 3px solid var(--theme-color); padding-left: 6px;
        }
        .section-title:first-child { margin-top: 0; }

        .control-row { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .control-row label { color: #555; font-weight: bold; min-width: 60px; }
        .control-row input, .control-row select { flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px; margin-left: 5px; }
        .slider-container { flex: 1; display: flex; align-items: center; gap: 5px; margin-left: 5px;}
        .slider-container input { flex: 1; }

        /* æŒ‰é’®ç»„ */
        .btn-full { width: 100%; padding: 6px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-top: 5px; color: #333; }
        .btn-full:hover { background: #e0e0e0; }
        .btn-primary { background: var(--theme-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: #ff5252; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* äº‘åŒæ­¥ */
        .cloud-status { font-size: 10px; color: #999; text-align: right; margin-top: 2px; }
        .cloud-status.success { color: green; }
        .cloud-status.error { color: red; }
        .cloud-row { display: flex; gap: 5px; margin-top: 5px; }
        .btn-cloud { flex: 1; font-size: 12px; padding: 5px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-upload { background: #2196F3; } .btn-upload:hover { background: #1976D2; }
        .btn-download { background: #FF9800; } .btn-download:hover { background: #F57C00; }

    </style>
</head>
<body>

    <div class="btn-group">
        <button class="float-btn green" onclick="saveAsImage()">ğŸ–¼ï¸ å­˜ä¸ºå›¾ç‰‡</button>
        <button class="float-btn" onclick="window.print()">ğŸ–¨ï¸ æ‰“å° / PDF</button>
    </div>

    <div class="a4-page" id="capture-area">
        <img src="../images/bdcæ°´å°.jpg" id="bg-watermark" alt="æ°´å°" style="top: 40px; left: 0px;">
        <img src="../images/hfbdc.png" id="stamp-layer" alt="å°ç« " style="top: 375px; left: 460px; width: 160px;">

        <div class="content-layer">
            
            <div class="header">
                <div class="header-title">
                    <h1>åˆè‚¥å¸‚ä¸åŠ¨äº§ç™»è®°ä¿¡æ¯æŸ¥è¯¢ç»“æœ</h1>
                    <div class="header-info" contenteditable="true" id="txtHeaderInfo">ä¾ç”³è¯·ï¼Œç»è¿‡æŸ¥è¯¢ åˆè‚¥å¸‚ä¸åŠ¨äº§ç»Ÿä¸€ç™»è®°ä¿¡æ¯ç®¡ç†ç³»ç»Ÿï¼Œç»“æœå¦‚ä¸‹ï¼š</div>
                </div>
                <img src="../images/hfqr-100.jpg" id="qr-img" class="qr-code" alt="QR">
            </div>

            <div class="section-title">äº§æƒä¿¡æ¯</div>
            <table>
                <colgroup>
                    <col style="width: 28%"> <col style="width: 12%"> <col style="width: 25%"> 
                    <col style="width: 12%"> <col style="width: 11%"> <col style="width: 12%">
                </colgroup>
                <tr>
                    <th>ä¸åŠ¨äº§æƒè¯å·</th> <th>æƒåˆ©äºº</th> <th>è¯ä»¶å·</th>
                    <th>ç™»è®°ç±»å‹</th> <th>ç™»è®°åŸå› </th> <th>ç™»è®°æ—¶é—´</th>
                </tr>
                <tr>
                    <td contenteditable="true" id="t1_certNo">çš–(2021)åˆè‚¥å¸‚ä¸åŠ¨äº§æƒ<br>ç¬¬4145544å·</td>
                    <td contenteditable="true" id="t1_owner">é¡¾éœ²äº‘</td>
                    <td contenteditable="true" id="t1_id">342622199106302421</td>
                    <td contenteditable="true" id="t1_type">è½¬ç§»ç™»è®°</td>
                    <td contenteditable="true" id="t1_reason">å­˜é‡æˆ¿ä¹°å–</td>
                    <td contenteditable="true" id="t1_date">2021-10-22</td>
                </tr>
            </table>

            <div class="section-title">ä¸åŠ¨äº§è¯¦æƒ…ï¼ˆé¢ç§¯å•ä½ï¼šå¹³æ–¹ç±³ï¼‰</div>
            <table>
                <colgroup>
                    <col style="width: 8%"> <col style="width: 8%"> <col style="width: 8%"> 
                    <col style="width: 10%"> <col style="width: 14%"> <col style="width: 12%"> 
                    <col style="width: 12%"> <col style="width: 12%"> <col style="width: 16%">
                </colgroup>
                <tr>
                    <td colspan="2">å…±æœ‰æƒ…å†µ</td>
                    <td colspan="2" contenteditable="true" id="t2_share">å•ç‹¬æ‰€æœ‰</td>
                    <td colspan="2">ä¸åŠ¨äº§å•å…ƒå·</td>
                    <td colspan="3" contenteditable="true" id="t2_unit">340104401007GB00071F00020062</td>
                </tr>
                <tr>
                    <td colspan="2">åè½</td>
                    <td colspan="7" contenteditable="true" id="t2_addr">èœ€å±±åŒºåé‡Œåº—è·¯719å·æ¸…æºªå®¶å›­5å¹¢1602</td>
                </tr>
                <tr>
                    <td>æ€»å±‚æ•°</td> <td>æ‰€åœ¨å±‚</td> <td>å®¤å·</td> <td>è§„åˆ’ç”¨é€”</td> <td>æˆ¿å±‹æ€§è´¨</td> 
                    <td>å»ºç­‘é¢ç§¯</td> <td>ä¸“æœ‰é¢ç§¯</td> <td>åˆ†æ‘Šé¢ç§¯</td> <td>ç«£å·¥æ—¶é—´</td>
                </tr>
                <tr>
                    <td contenteditable="true" id="t2_totalFl">18</td>
                    <td contenteditable="true" id="t2_currFl">16</td>
                    <td contenteditable="true" id="t2_room">1602</td>
                    <td contenteditable="true" id="t2_usage">ä½å®…</td>
                    <td contenteditable="true" id="t2_nature">å¸‚åœºåŒ–å•†å“æˆ¿</td>
                    <td contenteditable="true" id="t2_areaBuild">97.02</td>
                    <td contenteditable="true" id="t2_areaPriv">81.36</td>
                    <td contenteditable="true" id="t2_areaShare">15.66</td>
                    <td contenteditable="true" id="t2_finish">2017-06-30</td>
                </tr>
                <tr>                    
                    <td colspan="2">åœŸåœ°ä½¿ç”¨é¢ç§¯</td>
                    <td colspan="2" contenteditable="true" id="t2_landArea">50188.64</td>
                    <td colspan="2">åœŸåœ°ä½¿ç”¨æœŸé™</td>
                    <td colspan="3" contenteditable="true" id="t2_landDate">è‡³2090-06-27</td>
                </tr>
                <tr>
                    <td colspan="2">å®—åœ°é¢ç§¯</td>
                    <td colspan="3" contenteditable="true" id="t2_zoneArea">50188.64</td>
                    <td colspan="2">å®—åœ°æ€§è´¨</td>
                    <td colspan="2" contenteditable="true" id="t2_zoneNature">å‡ºè®©</td>
                </tr>
                <tr>
                    <td colspan="2">å®—åœ°æƒåˆ©ç±»å‹</td>
                    <td colspan="3" contenteditable="true" id="t2_zoneRightType">å›½æœ‰å»ºè®¾ç”¨åœ°ä½¿ç”¨æƒ</td>
                    <td colspan="2">å®—åœ°ç”¨é€”</td>
                    <td colspan="2" contenteditable="true" id="t2_zoneUsage">åŸé•‡ä½å®…ç”¨åœ°</td>
                </tr>
                <tr>
                    <td colspan="2">å®—åœ°ç”¨é€” 2</td>
                    <td colspan="3" contenteditable="true" id="t2_zoneUsage2"></td>
                    <td colspan="2">å®—åœ°ç”¨é€” 3</td>
                    <td colspan="2" contenteditable="true" id="t2_zoneUsage3"></td>
                </tr>
                <tr>
                    <td colspan="2">é™„è®°</td>
                    <td colspan="7" contenteditable="true" id="t2_remarks"></td>
                </tr>
            </table>

            <div class="section-title">æŠµæŠ¼ä¿¡æ¯ï¼ˆé‡‘é¢å•ä½ï¼šä¸‡å…ƒï¼‰</div>
            <table>
                <colgroup>
                    <col style="width: 22%"> <col style="width: 15%"> <col style="width: 10%"> <col style="width: 10%"> 
                    <col style="width: 15%"> <col style="width: 12%"> <col style="width: 10%"> <col style="width: 6%"> 
                </colgroup>
                <tr>
                    <th>ä¸åŠ¨äº§è¯æ˜å·</th> <th>æŠµæŠ¼æƒäºº</th> <th>æŠµæŠ¼æ–¹å¼</th> <th>æŠµæŠ¼é‡‘é¢</th>
                    <th>å€ºåŠ¡å±¥è¡ŒæœŸé™</th> <th>ç™»è®°æ—¶é—´</th> <th>ç¦æ­¢è½¬è®©</th> <th>é™„è®°</th>
                </tr>
                <tr>
                    <td contenteditable="true" id="t3_cert">çš–(2025)åˆè‚¥å¸‚ä¸åŠ¨<br>äº§è¯æ˜ç¬¬4009908å·</td>
                    <td contenteditable="true" id="t3_person">å®‰å¾½ä¹é¼å…¸å½“<br>æœ‰é™å…¬å¸</td>
                    <td contenteditable="true" id="t3_type">ä¸€èˆ¬æŠµæŠ¼</td>
                    <td contenteditable="true" id="t3_amt">64</td>
                    <td contenteditable="true" id="t3_term">2025-11-27 è‡³<br>2025-12-26</td>
                    <td contenteditable="true" id="t3_date">2025-12-01</td>
                    <td contenteditable="true" id="t3_forbid">æ˜¯</td>
                    <td contenteditable="true" id="t3_rem"></td>
                </tr>
            </table>

            <div class="section-title">æŸ¥å°ä¿¡æ¯ï¼ˆæ³¨ï¼šè½®å€™æŸ¥å°çš„å®é™…èµ·æ­¢æ—¥æœŸä¸ºå¾…å®šï¼‰</div>
            <table>
                <colgroup>
                    <col style="width: 15%"> <col style="width: 10%"> <col style="width: 20%"> <col style="width: 15%">
                    <col style="width: 15%"> <col style="width: 10%"> <col style="width: 15%">
                </colgroup>
                <tr>
                    <th>æŸ¥å°æœºæ„</th> <th>æŸ¥å°ç±»å‹</th> <th>æŸ¥å°æ–‡å·</th> <th>æŸ¥å°å¼€å§‹æ—¶é—´</th>
                    <th>æŸ¥å°ç»“æŸæ—¶é—´</th> <th>æ˜¯å¦è§£å°</th> <th>é™„è®°</th>
                </tr>
                <tr>
                    <td contenteditable="true" id="t4_org" style="height: 18px;"></td>
                    <td contenteditable="true" id="t4_type"></td>
                    <td contenteditable="true" id="t4_doc"></td>
                    <td contenteditable="true" id="t4_start"></td>
                    <td contenteditable="true" id="t4_end"></td>
                    <td contenteditable="true" id="t4_unseal"></td>
                    <td contenteditable="true" id="t4_rem"></td>
                </tr>
            </table>

            <div class="section-title">å¼‚è®®ä¿¡æ¯</div>
            <table>
                <tr>
                    <th style="width: 50%">å¼‚è®®äº‹é¡¹</th>
                    <th style="width: 50%">é™„è®°</th>
                </tr>
                <tr>
                    <td contenteditable="true" id="t5_item" style="height: 18px;"></td>
                    <td contenteditable="true" id="t5_rem"></td>
                </tr>
            </table>

            <div class="section-title">å±…ä½æƒä¿¡æ¯</div>
            <table>
                <colgroup>
                    <col style="width: 25%"> <col style="width: 20%"> <col style="width: 20%"> <col style="width: 15%"> <col style="width: 20%">
                </colgroup>
                <tr>
                    <th>ä¸åŠ¨äº§è¯æ˜å·</th> <th>å±…ä½æƒäºº</th> <th>å±…ä½æƒæœŸé™</th> <th>ç™»è®°æ—¶é—´</th> <th>é™„è®°</th>
                </tr>
                <tr>
                    <td contenteditable="true" id="t6_cert" style="height: 18px;"></td>
                    <td contenteditable="true" id="t6_person"></td>
                    <td contenteditable="true" id="t6_term"></td>
                    <td contenteditable="true" id="t6_date"></td>
                    <td contenteditable="true" id="t6_rem"></td>
                </tr>
            </table>

            <div class="footer-date" id="footerDateDisplay" contenteditable="true">
                2025 å¹´ 12 æœˆ 22 æ—¥ 14 æ—¶ 52 åˆ†
            </div>

            <div class="footer-notes">
                è¯´æ˜ï¼š<br>
                1ã€æœ¬æ¬¡æŸ¥è¯¢ç»“æœä¾æ®ä¸åŠ¨äº§ï¼ˆå«æˆ¿å±‹ï¼‰ç™»è®°ç°¿å‡ºå…·ï¼Œåæ˜ æŸ¥è¯¢äººç›®å‰å®é™…æ‹¥æœ‰çš„ä¸åŠ¨äº§æƒåˆ©ç™»è®°ä¿¡æ¯ã€‚<br>
                2ã€å¯èƒ½å› è¢«æŸ¥è¯¢äººèº«ä»½ä¿¡æ¯ä¸ç™»è®°ç°¿ä¸ä¸€è‡´å¯¼è‡´é”™è¯¯ç»“æœï¼ŒæŸ¥è¯¢äººè¯·å½“åœºæ ¸å®ä»¥ä¸Šèº«ä»½ä¿¡æ¯å’Œç»“æœä¿¡æ¯ï¼Œ<br>
                å¦‚ä¿¡æ¯æœ‰è¯¯æˆ–å¼‚è®®ï¼Œè¯·å‘ŠçŸ¥æ¡£æ¡ˆæŸ¥è¯¢å·¥ä½œäººå‘˜äºˆä»¥æ ¸å®ï¼Œå¦‚æœ‰éšç’æˆ–æä¾›è™šå‡ä¿¡æ¯è‡ªè¡Œæ‰¿æ‹…æ³•å¾‹è´£ä»»ã€‚<br>
                3ã€æŸ¥è¯¢ç»“æœä¸­ç©ºç™½æ ï¼Œå‡ä¸ºç™»è®°ç°¿ä¸­æ— æ­¤é¡¹ä¿¡æ¯ã€‚<br>
                4ã€æŸ¥è¯¢äººå¯¹ä»¥ä¸ŠæŸ¥è¯¢ä¸­æ¶‰åŠçš„ç›¸å…³ä¿¡æ¯è´Ÿæœ‰ä¿å¯†ä¹‰åŠ¡ã€‚
            </div>

        </div>
    </div>

    <div class="control-panel" id="controlPanel" onclick="handlePanelClick(event)">
        <div class="toggle-icon">âš™</div>
        
        <div class="panel-content">
            <div class="panel-header">
                <h4>è®¾ç½®ä¸æ¡£æ¡ˆ</h4>
                <span class="minimize-btn" onclick="minimizePanel(event)">_</span>
            </div>

            <div class="section-title">é¡µé¢å…ƒç´ </div>
            <div class="control-row">
                <label>æ—¥æœŸæ—¶é—´</label>
                <input type="datetime-local" id="datePicker" step="60" onchange="updateDate()">
            </div>
            <div class="control-row">
                <label>æ›¿æ¢äºŒç»´ç </label>
                <input type="file" accept="image/*" onchange="loadQR(this)" style="padding:2px;">
            </div>

            <div class="section-title">å°ç«  & æ°´å°</div>
            <div class="control-row">
                <label>å°ç« ä¸Šä¸‹</label>
                <div class="slider-container">
                    <input type="range" id="stampTop" min="0" max="1000" value="350" oninput="updateStamp()">
                </div>
            </div>
            <div class="control-row">
                <label>å°ç« å·¦å³</label>
                <div class="slider-container">
                    <input type="range" id="stampLeft" min="0" max="700" value="400" oninput="updateStamp()">
                </div>
            </div>
            <div class="control-row">
                <label>å°ç« å¤§å°</label>
                <div class="slider-container">
                    <input type="range" id="stampSize" min="50" max="300" value="160" oninput="updateStamp()">
                </div>
            </div>
            <div class="control-row">
                <label>åº•çº¹ä¸Šä¸‹</label>
                <div class="slider-container">
                    <input type="range" id="wmTop" min="-200" max="200" value="40" oninput="updateWatermark()">
                </div>
            </div>

            <div class="section-title">æœ¬åœ°æ¡£æ¡ˆåº“</div>
            <div class="control-row">
                <input type="text" id="dbSaveName" placeholder="æ¡£æ¡ˆå (è‡ªåŠ¨ç”Ÿæˆ)" style="margin-left:0;">
                <button class="btn-primary" onclick="saveToDB()" style="margin-left:5px;">ä¿å­˜</button>
            </div>
            <div class="control-row">
                <select id="dbList" onchange="loadFromDB()" style="margin-left:0;">
                    <option value="">-- å†å²è®°å½• --</option>
                </select>
                <button class="btn-danger" onclick="deleteFromDB()" style="margin-left:5px;">åˆ </button>
            </div>

            <div class="section-title">GitHub äº‘åŒæ­¥</div>
            <div class="control-row">
                <input type="password" id="ghToken" placeholder="ç²˜è´´ Token" onchange="saveToken()" style="margin-left:0;">
            </div>
            <div class="cloud-status" id="cloudStatus">æœªé…ç½®</div>
            <div class="cloud-row">
                <button class="btn-cloud btn-upload" onclick="syncToCloud('upload')">â¬† ä¸Šä¼ åˆ°äº‘</button>
                <button class="btn-cloud btn-download" onclick="syncToCloud('download')">â¬‡ ä»äº‘ä¸‹è½½</button>
            </div>
        </div>
    </div>

    <script>
        const fieldIds = [
            // å¤´éƒ¨ä¸æ—¥æœŸ
            "txtHeaderInfo", "footerDateDisplay",
            // è¡¨1 äº§æƒ
            "t1_certNo", "t1_owner", "t1_id", "t1_type", "t1_reason", "t1_date",
            // è¡¨2 è¯¦æƒ…
            "t2_share", "t2_unit", "t2_addr", 
            "t2_totalFl", "t2_currFl", "t2_room", "t2_usage", "t2_nature", "t2_areaBuild", "t2_areaPriv", "t2_areaShare", "t2_finish",
            "t2_landArea", "t2_landDate", "t2_zoneArea", "t2_zoneNature", "t2_zoneRightType", "t2_zoneUsage", "t2_zoneUsage2", "t2_zoneUsage3", "t2_remarks",
            // è¡¨3 æŠµæŠ¼
            "t3_cert", "t3_person", "t3_type", "t3_amt", "t3_term", "t3_date", "t3_forbid", "t3_rem",
            // è¡¨4 æŸ¥å°
            "t4_org", "t4_type", "t4_doc", "t4_start", "t4_end", "t4_unseal", "t4_rem",
            // è¡¨5 å¼‚è®®
            "t5_item", "t5_rem",
            // è¡¨6 å±…ä½æƒ
            "t6_cert", "t6_person", "t6_term", "t6_date", "t6_rem",
            // æ§ä»¶å€¼
            "stampTop", "stampLeft", "stampSize", "wmTop", "wmLeft"
        ];

        const DB_KEY = "HFBDC_DB";
        const GIST_FILENAME = "hfbdc_db.json";
        const GIST_DESC = "Hefei Real Estate DB Backup";

        window.onload = function() {
            // åˆå§‹åŒ–æ—¥æœŸ
            const now = new Date(); 
            const picker = document.getElementById('datePicker');
            const yyyy = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            picker.value = `${yyyy}-${MM}-${dd}T${hh}:${mm}`;
            
            // å°è¯•ä¿æŒä¹‹å‰çš„æ—¶é—´æ˜¾ç¤º(å¦‚æœæœ‰çš„è¯)ï¼Œæ²¡æœ‰åˆ™åˆ·æ–°
            if(document.getElementById('footerDateDisplay').innerText.trim().length < 10) {
                updateDate(); 
            }

            refreshList();
            const savedToken = localStorage.getItem('GH_TOKEN');
            if(savedToken) {
                document.getElementById('ghToken').value = savedToken;
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        }

        // é¢æ¿äº¤äº’
        function handlePanelClick(e) {
            const panel = document.getElementById('controlPanel');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
            }
        }
        function minimizePanel(e) {
            e.stopPropagation(); 
            document.getElementById('controlPanel').classList.add('collapsed');
        }
        function toggleControlPanel() {
            document.getElementById('controlPanel').classList.toggle('collapsed');
        }

        // é¡µé¢é€»è¾‘
        function updateDate() {
            const val = document.getElementById('datePicker').value;
            if(val) {
                const d = new Date(val);
                const text = `${d.getFullYear()} å¹´ ${d.getMonth() + 1} æœˆ ${d.getDate()} æ—¥ ${d.getHours()} æ—¶ ${String(d.getMinutes()).padStart(2,'0')} åˆ†`;
                document.getElementById('footerDateDisplay').innerText = text;
            }
        }

        function loadQR(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('qr-img').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateStamp() {
            var top = document.getElementById('stampTop').value;
            var left = document.getElementById('stampLeft').value;
            var size = document.getElementById('stampSize').value;
            var stamp = document.getElementById('stamp-layer');
            stamp.style.top = top + 'px';
            stamp.style.left = left + 'px';
            stamp.style.width = size + 'px';
        }

        function updateWatermark() {
            var top = document.getElementById('wmTop').value;
            var left = document.getElementById('wmLeft').value; // è¿™é‡Œä¿®æ­£äº†å˜é‡å
            var wm = document.getElementById('bg-watermark');
            wm.style.top = top + 'px';
            wm.style.left = left + 'px'; // ç¡®ä¿è¿™é‡Œæ˜¯ px
        }

        function saveAsImage() {
            const element = document.getElementById('capture-area');
            html2canvas(element, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: "#ffffff" }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ä¸åŠ¨äº§äº§è°ƒç»“æœ.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            }).catch(err => { alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒã€‚"); });
        }

        // æ•°æ®åº“ & äº‘åŒæ­¥é€»è¾‘
        function saveToDB() {
            const owner = document.getElementById('t1_owner').innerText.trim() || "æœªå‘½å";
            const now = new Date();
            const timeStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            
            let saveName = document.getElementById('dbSaveName').value.trim();
            if(!saveName) saveName = `${owner}_${timeStr}`;

            const data = {};
            fieldIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    // åˆ¤æ–­æ˜¯ input/select è¿˜æ˜¯ editable div/td
                    if(el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                        data[id] = el.value;
                    } else {
                        data[id] = el.innerText; // é’ˆå¯¹è¡¨æ ¼å†…å®¹
                    }
                }
            });

            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            allData[saveName] = data;
            localStorage.setItem(DB_KEY, JSON.stringify(allData));

            alert(`âœ… å·²ä¿å­˜: ${saveName}`);
            refreshList();
            document.getElementById('dbSaveName').value = "";
        }

        function loadFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            const data = allData[name];
            if(data) {
                fieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el && data[id] !== undefined) {
                        if(el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                            el.value = data[id];
                        } else {
                            el.innerText = data[id];
                        }
                    }
                });
                // åŠ è½½å®Œæ•°æ®åï¼Œæ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å°ç« /æ°´å°ä½ç½®æ›´æ–°
                updateStamp();
                updateWatermark();
            }
        }

        function deleteFromDB() {
            const name = document.getElementById('dbList').value;
            if(!name) return;
            if(!confirm(`åˆ é™¤ [${name}] ?`)) return;
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            delete allData[name];
            localStorage.setItem(DB_KEY, JSON.stringify(allData));
            refreshList();
        }

        function refreshList() {
            const select = document.getElementById('dbList');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- å†å²è®°å½• --</option>';
            let allData = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
            Object.keys(allData).reverse().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                select.appendChild(opt);
            });
            if(allData[currentVal]) select.value = currentVal;
        }

        function saveToken() {
            const token = document.getElementById('ghToken').value.trim();
            if(token) {
                localStorage.setItem('GH_TOKEN', token);
                document.getElementById('cloudStatus').innerText = "Token å·²ä¿å­˜";
            }
        }

        async function syncToCloud(action) {
            const token = localStorage.getItem('GH_TOKEN');
            if(!token) { alert("è¯·å…ˆè¾“å…¥ GitHub Tokenï¼"); return; }
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerText = "è¿æ¥ä¸­...";
            statusDiv.className = "cloud-status";

            try {
                // éªŒè¯
                const userRes = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${token}` } });
                if(!userRes.ok) throw new Error("Token æ— æ•ˆ");

                // æ‰¾ Gist
                const gistsRes = await fetch('https://api.github.com/gists', { headers: { Authorization: `token ${token}` } });
                const gists = await gistsRes.json();
                let targetGist = gists.find(g => g.description === GIST_DESC && g.files[GIST_FILENAME]);
                let gistId = targetGist ? targetGist.id : null;

                if (action === 'upload') {
                    const content = localStorage.getItem(DB_KEY) || "{}";
                    const payload = { description: GIST_DESC, public: false, files: { [GIST_FILENAME]: { content: content } } };
                    let url = 'https://api.github.com/gists';
                    let method = 'POST';
                    if (gistId) { url += `/${gistId}`; method = 'PATCH'; }
                    
                    await fetch(url, { method: method, headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    statusDiv.innerText = "âœ… ä¸Šä¼ æˆåŠŸ"; statusDiv.classList.add("success"); alert("åŒæ­¥å®Œæˆ");

                } else if (action === 'download') {
                    if (!gistId) { alert("äº‘ç«¯æ— æ–‡ä»¶"); return; }
                    const detailRes = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { Authorization: `token ${token}` } });
                    const detail = await detailRes.json();
                    localStorage.setItem(DB_KEY, detail.files[GIST_FILENAME].content);
                    refreshList();
                    loadFromDB(); // è‡ªåŠ¨åŠ è½½æœ€æ–°ä¸€æ¡
                    statusDiv.innerText = "âœ… ä¸‹è½½æˆåŠŸ"; statusDiv.classList.add("success"); alert("å·²æ¢å¤");
                }
            } catch (error) {
                statusDiv.innerText = "âŒ " + error.message; statusDiv.classList.add("error");
            }
        }
    </script>
</body>
</html>